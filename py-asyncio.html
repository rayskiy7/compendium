<!DOCTYPE html> <html lang="en"><head>
<title>Py Asyncio</title>
<base href=".">
<meta name="pathname" content="py-asyncio.html">
<meta name="description" content="Compendium - Py Asyncio">
<meta property="og:title" content="Py Asyncio">
<meta property="og:description" content="Compendium - Py Asyncio">
<meta property="og:type" content="website">
<meta property="og:url" content="py-asyncio.html">
<meta property="og:image" content="undefined">
<meta charset="UTF-8"><meta property="og:site_name" content="Compendium"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=1.0, maximum-scale=5.0"><script async="" id="webpage-script" src="site-lib/scripts/webpage.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><link rel="icon" href="site-lib/media/favicon.png"><link rel="preload" href="site-lib/styles/snippets.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="site-lib/styles/snippets.css"></noscript><link rel="stylesheet" href="site-lib/styles/obsidian.css"><link rel="preload" href="site-lib/styles/other-plugins.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="site-lib/styles/other-plugins.css"></noscript><link rel="preload" href="site-lib/styles/global-variable-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="site-lib/styles/global-variable-styles.css"></noscript><link rel="preload" href="site-lib/styles/supported-plugins.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="site-lib/styles/supported-plugins.css"></noscript><link rel="preload" href="site-lib/styles/main-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="site-lib/styles/main-styles.css"></noscript><style>body{--line-width:40em;--line-width-adaptive:40em;--file-line-width:40em;--sidebar-width:min(20em, 80vw);--collapse-arrow-size:11px;--tree-vertical-spacing:1.3em;--sidebar-margin:12px}:root{background-color:#202124}.sidebar{height:100%;font-size:14px;z-index:10;min-width:calc(var(--sidebar-width) + var(--divider-width-hover));max-width:calc(var(--sidebar-width) + var(--divider-width-hover));position:relative;overflow:hidden;overflow:clip;transition:min-width ease-in-out,max-width ease-in-out;transition-duration:.2s;contain:size}#left-sidebar{left:0}#right-sidebar{right:0}.sidebar.is-collapsed{min-width:0;max-width:0}.sidebar.floating{position:absolute}.sidebar .leaf-content{height:100%;min-width:calc(var(--sidebar-width) - var(--divider-width-hover));top:0;padding:var(--sidebar-margin);padding-top:4em;line-height:var(--line-height-tight);background-color:var(--background-secondary);transition:background-color,border-right,border-left,box-shadow;transition-duration:var(--color-fade-speed);transition-timing-function:ease-in-out;position:absolute;display:flex;flex-direction:column}.sidebar:not(.is-collapsed) .leaf-content{min-width:calc(max(100%,var(--sidebar-width)) - 3px);max-width:calc(max(100%,var(--sidebar-width)) - 3px)}#left-sidebar-content{left:0;border-top-right-radius:var(--radius-l);border-bottom-right-radius:var(--radius-l)}#right-sidebar-content{right:0;border-top-left-radius:var(--radius-l);border-bottom-left-radius:var(--radius-l)}.sidebar #left-sidebar-content,.sidebar #right-sidebar-content{contain:none!important;container-type:normal!important;animation:none!important}.sidebar:has(.leaf-content:empty):has(.topbar-content:empty){display:none}.sidebar-topbar{height:calc(2.3em + 2 * var(--sidebar-margin));width:var(--sidebar-width);padding:var(--sidebar-margin);z-index:1;position:fixed;display:flex;align-items:center;transition:width ease-in-out;transition-duration:inherit}.sidebar.is-collapsed .sidebar-topbar{width:calc(2.3em + var(--sidebar-margin) * 2)}.sidebar .sidebar-topbar.is-collapsed{width:0}#left-sidebar .sidebar-topbar{left:0;flex-direction:row;border-top-right-radius:var(--radius-l)}#right-sidebar .sidebar-topbar{right:0;flex-direction:row-reverse;border-top-left-radius:var(--radius-l)}#left-sidebar .topbar-content{margin-right:calc(2.3em + var(--sidebar-margin));flex-direction:row}#right-sidebar .topbar-content{margin-left:calc(2.3em + var(--sidebar-margin));flex-direction:row-reverse}.topbar-content{overflow:hidden visible;overflow:clip visible;width:100%;height:100%;display:flex;align-items:center;transition:inherit}.sidebar.is-collapsed .topbar-content{width:0;transition:inherit}.clickable-icon.sidebar-collapse-icon{background-color:transparent;color:var(--icon-color-focused);padding:2px!important;margin:0!important;height:100%!important;width:2.3em!important;margin-inline:0.14em!important;position:absolute}#left-sidebar .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);right:var(--sidebar-margin)}#right-sidebar .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);left:var(--sidebar-margin)}.clickable-icon.sidebar-collapse-icon svg.svg-icon{width:100%;height:100%}.feature-title{margin-left:1px;text-transform:uppercase;letter-spacing:.06em;margin-top:.75em;margin-bottom:.75em}.feature-header{display:flex;align-items:center;padding-top:0;font-size:1em;padding-left:0}body.floating-sidebars .sidebar{position:absolute}body{transition:background-color var(--color-fade-speed) ease-in-out}#navbar:not(:empty){display:flex;align-items:center;justify-content:space-between;padding:.5em 1em;width:100%}#main{display:flex;flex-direction:column;height:100%;width:100%;align-items:stretch;justify-content:center}#main-horizontal{display:flex;flex-direction:row;flex-grow:1;width:100%;align-items:stretch;justify-content:center}#center-content{flex-basis:100%;max-width:100%;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;transition:opacity .2s ease-in-out;contain:inline-size}.hide{opacity:0!important;transition:opacity .2s ease-in-out;pointer-events:none}#center-content>.obsidian-document{padding-left:2em;padding-right:1em;margin-bottom:0;width:100%;width:-webkit-fill-available;width:-moz-available;width:fill-available;transition:background-color var(--color-fade-speed) ease-in-out;border-top-right-radius:var(--window-radius,var(--radius-m));border-top-left-radius:var(--window-radius,var(--radius-m));overflow-x:hidden!important;overflow-y:auto!important;display:flex!important;flex-direction:column!important;align-items:center!important;contain:inline-size}body #center-content>.obsidian-document>.markdown-preview-sizer{padding-bottom:80vh;width:100%;max-width:var(--line-width);flex-basis:var(--line-width);transition:background-color var(--color-fade-speed) ease-in-out;contain:inline-size}#center-content>.obsidian-document>div{width:100%!important;transition:background-color var(--color-fade-speed) ease-in-out;contain:inline-size}#center-content>.obsidian-document:not([data-type=markdown]).embed{display:flex;padding:1em;height:100%;width:100%;align-items:center;justify-content:center}#center-content>.obsidian-document:not([data-type=markdown]).embed>*{max-width:100%;max-height:100%;object-fit:contain}:not(h1,h2,h3,h4,h5,h6,li):has(> :is(.math,table)){overflow-x:auto!important}#center-content>.obsidian-document:not([data-type=markdown]){overflow-x:auto;contain:content;padding:0;margin:0;height:100%}.obsidian-document[data-type=attachment]{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;width:100%}.obsidian-document[data-type=attachment]>*{outline:0;border:none;box-shadow:none}.obsidian-document[data-type=attachment] :is(img){max-width:90%;max-height:90%;object-fit:contain}.obsidian-document[data-type=attachment]>:is(audio){width:100%;max-width:min(90%,var(--line-width))}.obsidian-document[data-type=attachment]>:is(embed,iframe,video){width:100%;height:100%;max-width:100%;max-height:100%;object-fit:contain}.canvas-wrapper>:is(.header,.footer){z-index:100;position:absolute;display:flex;justify-content:center;flex-direction:column;width:100%;align-items:center}.scroll-highlight{position:absolute;width:100%;height:100%;pointer-events:none;z-index:1000;background-color:hsla(var(--color-accent-hsl),.25);opacity:0;padding:1em;inset:50%;translate:-50% -50%;border-radius:var(--radius-s)}</style><script defer="">async function loadIncludes(){let e=document.querySelectorAll("link[itemprop='include']");for(const t of e){let e=t.getAttribute("href");try{let o="";if(e.startsWith("https:")||e.startsWith("http:")||"file:"!=window.location.protocol){const n=await fetch(e);if(!n.ok){console.log("Could not include file: "+e),t?.remove();continue}o=await n.text()}else{const t=document.getElementById(btoa(encodeURI(e)));if(t){const e=JSON.parse(decodeURI(atob(t.getAttribute("value")??"")));o=e?.data??""}}let n=document.createRange().createContextualFragment(o);t.before(n),t.remove(),console.log("Included text: "+o),console.log("Included file: "+e)}catch(o){t?.remove(),console.log("Could not include file: "+e,o);continue}}}document.addEventListener("DOMContentLoaded",(()=>{loadIncludes()}));let isFileProtocol="file:"==location.protocol;function waitLoadScripts(e,t){let o=e.map((e=>document.getElementById(e+"-script")));!function e(n){let l=o[n],c=n+1;l?(l&&"true"!=l.getAttribute("loaded")||n<o.length&&e(c),n<o.length&&l.addEventListener("load",(()=>e(c)))):n<o.length?e(c):t()}(0)}</script></head><body class="publish css-settings-manager show-inline-title show-ribbon code-styler-style-inline code-styler code-styler-gutter-highlight is-focused"><script defer="">let theme=localStorage.getItem("theme")||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");"dark"==theme?(document.body.classList.add("theme-dark"),document.body.classList.remove("theme-light")):(document.body.classList.add("theme-light"),document.body.classList.remove("theme-dark")),window.innerWidth<480?document.body.classList.add("is-phone"):window.innerWidth<768?document.body.classList.add("is-tablet"):window.innerWidth<1024?document.body.classList.add("is-small-screen"):document.body.classList.add("is-large-screen")</script><div class="parsed-feature-container" style="display: contents;"><link itemprop="include" href="site-lib/html/custom-head-content-content.html"></div><div id="main"><div id="navbar"></div><div id="main-horizontal"><div id="left-content" class="leaf" style="--sidebar-width: var(--sidebar-width-left);"><div id="left-sidebar" class="sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"><div id="search-container"><div id="search-wrapper"><input enterkeyhint="search" type="search" spellcheck="false" placeholder="Search..."><div aria-label="Clear search" id="search-clear-button"></div></div></div></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content-wrapper"><div id="left-sidebar-content" class="leaf-content"><link itemprop="include" href="site-lib/html/file-tree-content.html"></div></div><script defer="">let ls = document.querySelector("#left-sidebar"); ls.classList.toggle("is-collapsed", window.innerWidth < 768); ls.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-left-width"));</script></div></div><div id="center-content" class="leaf"><div class="obsidian-document markdown-preview-view markdown-rendered node-insert-event is-readable-line-width allow-fold-headings allow-fold-lists show-indentation-guide show-properties" data-type="markdown"><style id="MJX-CHTML-styles">mjx-c.mjx-c2200::before{padding:.694em .556em .022em 0;content:"∀"}mjx-texatom{display:inline-block;text-align:left}mjx-c.mjx-c1D43A.TEX-I::before{padding:.705em .786em .022em 0;content:"G"}mjx-c.mjx-c1D443.TEX-I::before{padding:.683em .751em 0 0;content:"P"}mjx-c.mjx-c1D434.TEX-I::before{padding:.716em .75em 0 0;content:"A"}mjx-c.mjx-c1D447.TEX-I::before{padding:.677em .704em 0 0;content:"T"}mjx-c.mjx-c2014::before{padding:.285em 1em 0 0;content:"—"}mjx-c.mjx-c1D451.TEX-I::before{padding:.694em .52em .01em 0;content:"d"}mjx-c.mjx-c1D452.TEX-I::before{padding:.442em .466em .011em 0;content:"e"}mjx-c.mjx-c1D453.TEX-I::before{padding:.705em .55em .205em 0;content:"f"}mjx-c.mjx-c1D456.TEX-I::before{padding:.661em .345em .011em 0;content:"i"}mjx-c.mjx-c1D460.TEX-I::before{padding:.442em .469em .01em 0;content:"s"}mjx-c.mjx-c1D461.TEX-I::before{padding:.626em .361em .011em 0;content:"t"}mjx-c.mjx-c210E.TEX-I::before{padding:.694em .576em .011em 0;content:"h"}mjx-c.mjx-c1D464.TEX-I::before{padding:.443em .716em .011em 0;content:"w"}mjx-c.mjx-c1D45F.TEX-I::before{padding:.442em .451em .011em 0;content:"r"}mjx-c.mjx-c1D45D.TEX-I::before{padding:.442em .503em .194em 0;content:"p"}mjx-c.mjx-c1D44E.TEX-I::before{padding:.441em .529em .01em 0;content:"a"}mjx-c.mjx-c1D450.TEX-I::before{padding:.442em .433em .011em 0;content:"c"}mjx-c.mjx-c1D466.TEX-I::before{padding:.442em .49em .205em 0;content:"y"}mjx-c.mjx-c1D442.TEX-I::before{padding:.704em .763em .022em 0;content:"O"}mjx-c.mjx-c28::before{padding:.75em .389em .25em 0;content:"("}mjx-c.mjx-c1D459.TEX-I::before{padding:.694em .298em .011em 0;content:"l"}mjx-c.mjx-c1D45C.TEX-I::before{padding:.441em .485em .011em 0;content:"o"}mjx-c.mjx-c1D454.TEX-I::before{padding:.442em .477em .205em 0;content:"g"}mjx-c.mjx-c1D45B.TEX-I::before{padding:.442em .6em .011em 0;content:"n"}mjx-c.mjx-c29::before{padding:.75em .389em .25em 0;content:")"}mjx-container[jax=CHTML]{line-height:0}mjx-container [space="1"]{margin-left:.111em}mjx-container [space="2"]{margin-left:.167em}mjx-container [space="3"]{margin-left:.222em}mjx-container [space="4"]{margin-left:.278em}mjx-container [space="5"]{margin-left:.333em}mjx-container [rspace="1"]{margin-right:.111em}mjx-container [rspace="2"]{margin-right:.167em}mjx-container [rspace="3"]{margin-right:.222em}mjx-container [rspace="4"]{margin-right:.278em}mjx-container [rspace="5"]{margin-right:.333em}mjx-container [size="s"]{font-size:70.7%}mjx-container [size=ss]{font-size:50%}mjx-container [size=Tn]{font-size:60%}mjx-container [size=sm]{font-size:85%}mjx-container [size=lg]{font-size:120%}mjx-container [size=Lg]{font-size:144%}mjx-container [size=LG]{font-size:173%}mjx-container [size=hg]{font-size:207%}mjx-container [size=HG]{font-size:249%}mjx-container [width=full]{width:100%}mjx-box{display:inline-block}mjx-block{display:block}mjx-itable{display:inline-table}mjx-row{display:table-row}mjx-row>*{display:table-cell}mjx-mtext{display:inline-block}mjx-mstyle{display:inline-block}mjx-merror{display:inline-block;color:red;background-color:#ff0}mjx-mphantom{visibility:hidden}mjx-assistive-mml{top:0;left:0;clip:rect(1px,1px,1px,1px);user-select:none;position:absolute!important;padding:1px 0 0!important;border:0!important;display:block!important;width:auto!important;overflow:hidden!important}mjx-assistive-mml[display=block]{width:100%!important}mjx-math{display:inline-block;text-align:left;line-height:0;text-indent:0;font-style:normal;font-weight:400;font-size:100%;font-size-adjust:none;letter-spacing:normal;border-collapse:collapse;overflow-wrap:normal;word-spacing:normal;white-space:nowrap;direction:ltr;padding:1px 0}mjx-container[jax=CHTML][display=true]{display:block;text-align:center;margin:1em 0}mjx-container[jax=CHTML][display=true][width=full]{display:flex}mjx-container[jax=CHTML][display=true] mjx-math{padding:0}mjx-container[jax=CHTML][justify=left]{text-align:left}mjx-container[jax=CHTML][justify=right]{text-align:right}mjx-mo{display:inline-block;text-align:left}mjx-stretchy-h{display:inline-table;width:100%}mjx-stretchy-h>*{display:table-cell;width:0}mjx-stretchy-h>*>mjx-c{display:inline-block;transform:scaleX(1)}mjx-stretchy-h>*>mjx-c::before{display:inline-block;width:initial}mjx-stretchy-h>mjx-ext{overflow:clip visible;width:100%}mjx-stretchy-h>mjx-ext>mjx-c::before{transform:scaleX(500)}mjx-stretchy-h>mjx-ext>mjx-c{width:0}mjx-stretchy-h>mjx-beg>mjx-c{margin-right:-.1em}mjx-stretchy-h>mjx-end>mjx-c{margin-left:-.1em}mjx-stretchy-v{display:inline-block}mjx-stretchy-v>*{display:block}mjx-stretchy-v>mjx-beg{height:0}mjx-stretchy-v>mjx-end>mjx-c{display:block}mjx-stretchy-v>*>mjx-c{transform:scaleY(1);transform-origin:left center;overflow:hidden}mjx-stretchy-v>mjx-ext{display:block;height:100%;box-sizing:border-box;border:0 solid transparent;overflow:visible clip}mjx-stretchy-v>mjx-ext>mjx-c::before{width:initial;box-sizing:border-box}mjx-stretchy-v>mjx-ext>mjx-c{transform:scaleY(500) translateY(.075em);overflow:visible}mjx-mark{display:inline-block;height:0}mjx-c{display:inline-block}mjx-utext{display:inline-block;padding:.75em 0 .2em}mjx-msup{display:inline-block;text-align:left}mjx-mn{display:inline-block;text-align:left}mjx-mi{display:inline-block;text-align:left}mjx-c::before{display:block;width:0}.MJX-TEX{font-family:MJXZERO,MJXTEX}.TEX-B{font-family:MJXZERO,MJXTEX-B}.TEX-I{font-family:MJXZERO,MJXTEX-I}.TEX-MI{font-family:MJXZERO,MJXTEX-MI}.TEX-BI{font-family:MJXZERO,MJXTEX-BI}.TEX-S1{font-family:MJXZERO,MJXTEX-S1}.TEX-S2{font-family:MJXZERO,MJXTEX-S2}.TEX-S3{font-family:MJXZERO,MJXTEX-S3}.TEX-S4{font-family:MJXZERO,MJXTEX-S4}.TEX-A{font-family:MJXZERO,MJXTEX-A}.TEX-C{font-family:MJXZERO,MJXTEX-C}.TEX-CB{font-family:MJXZERO,MJXTEX-CB}.TEX-FR{font-family:MJXZERO,MJXTEX-FR}.TEX-FRB{font-family:MJXZERO,MJXTEX-FRB}.TEX-SS{font-family:MJXZERO,MJXTEX-SS}.TEX-SSB{font-family:MJXZERO,MJXTEX-SSB}.TEX-SSI{font-family:MJXZERO,MJXTEX-SSI}.TEX-SC{font-family:MJXZERO,MJXTEX-SC}.TEX-T{font-family:MJXZERO,MJXTEX-T}.TEX-V{font-family:MJXZERO,MJXTEX-V}.TEX-VB{font-family:MJXZERO,MJXTEX-VB}mjx-stretchy-h mjx-c,mjx-stretchy-v mjx-c{font-family:MJXZERO,MJXTEX-S1,MJXTEX-S4,MJXTEX,MJXTEX-A!important}@font-face{font-family:MJXZERO;src:url("site-lib/fonts/mathjax_zero.woff") format("woff")}@font-face{font-family:MJXTEX;src:url("site-lib/fonts/mathjax_main-regular.woff") format("woff")}@font-face{font-family:MJXTEX-B;src:url("site-lib/fonts/mathjax_main-bold.woff") format("woff")}@font-face{font-family:MJXTEX-I;src:url("site-lib/fonts/mathjax_math-italic.woff") format("woff")}@font-face{font-family:MJXTEX-MI;src:url("site-lib/fonts/mathjax_main-italic.woff") format("woff")}@font-face{font-family:MJXTEX-BI;src:url("site-lib/fonts/mathjax_math-bolditalic.woff") format("woff")}@font-face{font-family:MJXTEX-S1;src:url("site-lib/fonts/mathjax_size1-regular.woff") format("woff")}@font-face{font-family:MJXTEX-S2;src:url("site-lib/fonts/mathjax_size2-regular.woff") format("woff")}@font-face{font-family:MJXTEX-S3;src:url("site-lib/fonts/mathjax_size3-regular.woff") format("woff")}@font-face{font-family:MJXTEX-S4;src:url("site-lib/fonts/mathjax_size4-regular.woff") format("woff")}@font-face{font-family:MJXTEX-A;src:url("site-lib/fonts/mathjax_ams-regular.woff") format("woff")}@font-face{font-family:MJXTEX-C;src:url("site-lib/fonts/mathjax_calligraphic-regular.woff") format("woff")}@font-face{font-family:MJXTEX-CB;src:url("site-lib/fonts/mathjax_calligraphic-bold.woff") format("woff")}@font-face{font-family:MJXTEX-FR;src:url("site-lib/fonts/mathjax_fraktur-regular.woff") format("woff")}@font-face{font-family:MJXTEX-FRB;src:url("site-lib/fonts/mathjax_fraktur-bold.woff") format("woff")}@font-face{font-family:MJXTEX-SS;src:url("site-lib/fonts/mathjax_sansserif-regular.woff") format("woff")}@font-face{font-family:MJXTEX-SSB;src:url("site-lib/fonts/mathjax_sansserif-bold.woff") format("woff")}@font-face{font-family:MJXTEX-SSI;src:url("site-lib/fonts/mathjax_sansserif-italic.woff") format("woff")}@font-face{font-family:MJXTEX-SC;src:url("site-lib/fonts/mathjax_script-regular.woff") format("woff")}@font-face{font-family:MJXTEX-T;src:url("site-lib/fonts/mathjax_typewriter-regular.woff") format("woff")}@font-face{font-family:MJXTEX-V;src:url("site-lib/fonts/mathjax_vector-regular.woff") format("woff")}@font-face{font-family:MJXTEX-VB;src:url("site-lib/fonts/mathjax_vector-bold.woff") format("woff")}mjx-c.mjx-c5B::before{padding:.75em .278em .25em 0;content:"["}mjx-c.mjx-c2212::before{padding:.583em .778em .082em 0;content:"−"}mjx-c.mjx-c32::before{padding:.666em .5em 0 0;content:"2"}mjx-c.mjx-c1D458.TEX-I::before{padding:.694em .521em .011em 0;content:"k"}mjx-c.mjx-c2C::before{padding:.121em .278em .194em 0;content:","}mjx-c.mjx-c31::before{padding:.666em .5em 0 0;content:"1"}mjx-c.mjx-c5D::before{padding:.75em .278em .25em 0;content:"]"}mjx-c.mjx-c30::before{padding:.666em .5em .022em 0;content:"0"}mjx-c.mjx-c1D43B.TEX-I::before{padding:.683em .888em 0 0;content:"H"}mjx-c.mjx-c3D::before{padding:.583em .778em .082em 0;content:"="}mjx-c.mjx-c1D438.TEX-I::before{padding:.68em .764em 0 0;content:"E"}mjx-c.mjx-c2287::before{padding:.636em .778em .138em 0;content:"⊇"}mjx-c.mjx-c2217::before{padding:.465em .5em 0 0;content:"∗"}mjx-c.mjx-c222A::before{padding:.598em .667em .022em 0;content:"∪"}</style><div class="markdown-preview-sizer markdown-preview-section"><div class="header"><h1 class="page-title heading inline-title" id="Py_Asyncio_0">Py Asyncio</h1><div class="data-bar"></div></div><div class="markdown-preview-pusher" style="width: 1px; height: 0.1px; margin-bottom: 0px;"></div><div class="el-p"><p dir="auto">This is my notes for the book:<br>
<strong>Python Concurrency with asyncio</strong> — <em>Matthew Fowler</em></p></div><div class="el-h1"><h1 data-heading="Chapters I &amp; II: Introduction to `asyncio`, The Basics" dir="auto" class="heading" id="Chapters_I_&amp;_II_Introduction_to_`asyncio`,_The_Basics_0"><span class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></span>Chapters I &amp; II: Introduction to <code class="code-styler-inline">asyncio</code>, The Basics</h1></div><div class="el-p"><p dir="auto">Types of multitasking:</p></div><div class="el-ul"><ul class="has-list-bullet">
<li data-line="0" dir="auto"><span class="list-bullet"></span>Preemptive<br>
The CPU itself decides when to switch between threads/processes.</li>
<li data-line="2" dir="auto"><span class="list-bullet"></span>Cooperative (non-preemptive)<br>
We manually write points in the code where control can be yielded.</li>
</ul></div><div class="el-p"><p dir="auto">Process — like a running application with its own memory space.<br>
Thread — the smallest unit of execution, usually created by a process. For example, a process always creates its main thread.</p></div><div class="el-p"><p dir="auto">Processes create threads.<br>
Process_1: main thread, side thread #1, side thread #2.</p></div><div class="el-p"><p dir="auto">Libraries:</p></div><div class="el-ul"><ul class="has-list-bullet">
<li data-line="0" dir="auto"><span class="list-bullet"></span>threading</li>
<li data-line="1" dir="auto"><span class="list-bullet"></span>multiprocessing</li>
<li data-line="2" dir="auto"><span class="list-bullet"></span>asyncio</li>
</ul></div><div class="el-p"><p dir="auto">New keywords:</p></div><div class="el-ul"><ul class="has-list-bullet">
<li data-line="0" dir="auto"><span class="list-bullet"></span>async — (coroutine creation)</li>
<li data-line="1" dir="auto"><span class="list-bullet"></span>async for</li>
<li data-line="2" dir="auto"><span class="list-bullet"></span>async with</li>
<li data-line="3" dir="auto"><span class="list-bullet"></span>await — (suspending a coroutine to wait for another, usually long-running operation)</li>
</ul></div><div class="el-p"><p dir="auto">Calls:</p></div><div class="el-ul"><ul class="has-list-bullet">
<li data-line="0" dir="auto"><span class="list-bullet"></span>calling a function returns a result</li>
<li data-line="1" dir="auto"><span class="list-bullet"></span>calling a generator returns a generator object</li>
<li data-line="2" dir="auto"><span class="list-bullet"></span>calling a coroutine returns a coroutine object</li>
<li data-line="3" dir="auto"><span class="list-bullet"></span>calling an asynchronous (coroutine) generator returns an object suitable for <code class="code-styler-inline">async for</code></li>
</ul></div><div class="el-p"><p dir="auto">Main entry point for an asyncio application:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python"><code data-line="0" class="language-python is-loaded">asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>coroutine<span class="token punctuation">:</span> coroutine<span class="token punctuation">)</span> —<span class="token operator">&gt;</span> tp<span class="token punctuation">.</span>Any
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Creating a task that starts immediately:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python"><code data-line="0" class="language-python is-loaded">asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>coroutine<span class="token punctuation">)</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Checking if a task is finished:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python"><code data-line="0" class="language-python is-loaded">task<span class="token punctuation">.</span>done<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># bool</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Cancelling a task:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python"><code data-line="0" class="language-python is-loaded">task<span class="token punctuation">.</span>cancel<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># raises a CancelledError exception</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Checking if a task was cancelled explicitly or by timeout:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python"><code data-line="0" class="language-python is-loaded">task<span class="token punctuation">.</span>cancelled<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># bool</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Task result:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python"><code data-line="0" class="language-python is-loaded">task<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Task exception:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python"><code data-line="0" class="language-python is-loaded">task<span class="token punctuation">.</span>exception<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Waiting with a 2-second timeout:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python"><code data-line="0" class="language-python is-loaded"><span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>wait_for<span class="token punctuation">(</span>subtask<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token comment"># raises asyncio.TimeoutError if time expires</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Protecting a task from cancellation:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python"><code data-line="0" class="language-python is-loaded">asyncio<span class="token punctuation">.</span>shield<span class="token punctuation">(</span>task<span class="token punctuation">)</span>  <span class="token comment"># returns a task that cannot be cancelled</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">At the moment of creation, a Future object is referred to as one of:</p></div><div class="el-ul"><ul class="has-list-bullet">
<li data-line="0" dir="auto"><span class="list-bullet"></span>incomplete</li>
<li data-line="1" dir="auto"><span class="list-bullet"></span>unresolved</li>
<li data-line="2" dir="auto"><span class="list-bullet"></span>not done<br>
But after receiving a value, it is called:</li>
<li data-line="4" dir="auto"><span class="list-bullet"></span>complete</li>
<li data-line="5" dir="auto"><span class="list-bullet"></span>done</li>
</ul></div><div class="el-p"><p dir="auto">Methods of asyncio.Future objects:</p></div><div class="el-ul"><ul class="has-list-bullet">
<li data-line="0" dir="auto"><span class="list-bullet"></span>done()</li>
<li data-line="1" dir="auto"><span class="list-bullet"></span>set_result()</li>
<li data-line="2" dir="auto"><span class="list-bullet"></span>set_exception()</li>
<li data-line="3" dir="auto"><span class="list-bullet"></span>result()</li>
<li data-line="4" dir="auto"><span class="list-bullet"></span>InvalidState  # exception raised when trying to retrieve a result that isn't ready</li>
</ul></div><div class="el-p"><p dir="auto">Future objects can be awaited using <code class="code-styler-inline">await</code>.<br>
Awaitable objects are those that implement <code class="code-styler-inline">__await__</code>.</p></div><div class="el-p"><p dir="auto">General structure:</p></div><div class="el-p"><p dir="auto">A Task is, in a sense, a pair (Coroutine + Future).</p></div><div class="el-p"><p dir="auto">! Useful: <code class="code-styler-inline">functools.wraps</code> — a decorator that updates a wrapper so that the function retains its original name and docstring.</p></div><div class="el-p"><p dir="auto">CPU-bound tasks can be run truly in parallel using asyncio tools, but this must be done within a process pool.</p></div><div class="el-p"><p dir="auto">An asyncio event loop can be created manually:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python"><code data-line="0" class="language-python is-loaded">loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>new_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Event loop methods (I):</p></div><div class="el-ol"><ol>
<li data-line="0" dir="auto">loop.run_until_complete() — unfinished tasks are not cancelled.</li>
<li data-line="1" dir="auto">loop.close — free resources at the end, best used in a <code class="code-styler-inline">finally</code> block.</li>
<li data-line="2" dir="auto">loop.call_soon() — call a callable on the next iteration of the event loop.</li>
<li data-line="3" dir="auto">loop.slow_callback_duration = .250 — set the threshold in seconds for debug mode.</li>
</ol></div><div class="el-p"><p dir="auto">Ways to get the event loop:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python"><code data-line="0" class="language-python is-loaded">asyncio<span class="token punctuation">.</span>get_running_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># recommended, fails if there is no loop</span>

asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># creates a loop if it doesn't exist</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Ways to enter debug mode:</p></div><div class="el-ol"><ol>
<li data-line="0" dir="auto">asyncio.run(coroutine(), debug=True)</li>
<li data-line="1" dir="auto">…% python3 -X dev program.py</li>
<li data-line="2" dir="auto">…% PYTHONASYNCIODEBUG=1 python3 program.py</li>
</ol></div><div class="el-h1"><h1 data-heading="Chapter III: First `asyncio` Application. Echo Server" dir="auto" class="heading" id="Chapter_III_First_`asyncio`_Application._Echo_Server_0"><span class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></span>Chapter III: First <code class="code-styler-inline">asyncio</code> Application. Echo Server</h1></div><div class="el-p"><p dir="auto">Network protocols:</p></div><div class="el-ul"><ul class="has-list-bullet">
<li data-line="0" dir="auto"><span class="list-bullet"></span>TCP — reliable data transfer without loss, but with overhead.</li>
<li data-line="1" dir="auto"><span class="list-bullet"></span>UDP — less reliable, but with less overhead.</li>
</ul></div><div class="el-p"><p dir="auto">Creating a socket:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python"><code data-line="0" class="language-python is-loaded">socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>family<span class="token operator">=</span><span class="token operator">&lt;</span>socket<span class="token punctuation">.</span>AF_INET<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token operator">&lt;</span>socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token operator">&gt;</span><span class="token punctuation">)</span>  <span class="token comment"># can be used in a with statement</span>
socket<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>level<span class="token operator">=</span><span class="token operator">&lt;</span>socket<span class="token punctuation">.</span>SOL_SOCKET<span class="token operator">&gt;</span><span class="token punctuation">,</span> optname<span class="token operator">=</span><span class="token operator">&lt;</span>socket<span class="token punctuation">.</span>SO_REUSEADDR<span class="token operator">&gt;</span><span class="token punctuation">,</span> value<span class="token operator">=</span><span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">)</span>
socket<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
socket<span class="token punctuation">.</span>bind<span class="token punctuation">(</span>address<span class="token operator">=</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span> <span class="token number">8000</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">)</span>
socket<span class="token punctuation">.</span>setblocking<span class="token punctuation">(</span>value<span class="token punctuation">:</span><span class="token builtin">bool</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span>do something <span class="token keyword">with</span> socket<span class="token operator">&gt;</span>
socket<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Socket methods:</p></div><div class="el-ul"><ul class="has-list-bullet">
<li data-line="0" dir="auto"><span class="list-bullet"></span>socket.listen() — switch to "listening" mode.</li>
<li data-line="1" dir="auto"><span class="list-bullet"></span>socket.accept() — wait for a connection and return it.</li>
<li data-line="2" dir="auto"><span class="list-bullet"></span>socket.recv(n: int) — receive n bytes.</li>
<li data-line="3" dir="auto"><span class="list-bullet"></span>socket.sendall(bytes) — send bytes.</li>
<li data-line="4" dir="auto"><span class="list-bullet"></span>socket.close() — close the socket.</li>
<li data-line="5" dir="auto"><span class="list-bullet"></span>socket.shutdown(&lt;socket.SHUT_RDWR&gt;)</li>
</ul></div><div class="el-p"><p dir="auto">There are many ways to connect to a server. One of them is telnet (<code class="code-styler-inline">brew install telnet</code>).</p></div><div class="el-p"><p dir="auto"><strong>SELECTORS</strong>:<br>
The notification system for socket events is built around the Selector class:</p></div><div class="el-ul"><ul class="has-list-bullet">
<li data-line="0" dir="auto"><span class="list-bullet"></span>BaseSelector — abstract base class.</li>
<li data-line="1" dir="auto"><span class="list-bullet"></span>DefaultSelector — automatically selected implementation for a specific system.</li>
</ul></div><div class="el-p"><p dir="auto">A single selector object can handle a pool of sockets at once.</p></div><div class="el-p"><p dir="auto">Important concepts of selectors:</p></div><div class="el-ol"><ol>
<li data-line="0" dir="auto"><u>Registration</u>. Each socket must be registered, specifying which events we are interested in. Registration can be cancelled when finished.</li>
<li data-line="1" dir="auto"><u>Selection</u>. Blocking while waiting for an event. Returns a list of sockets and their events that are ready for processing. A timeout is available.</li>
</ol></div><div class="el-p"><p dir="auto">In short, selectors are part of the event loop, which asyncio uses under the hood. Therefore, we often don't need to dive into selectors and create our own event loops!</p></div><div class="el-p"><p dir="auto"><strong>WORKING WITH SOCKETS IN ASYNCIO:</strong><br>
Methods for handling sockets belong to the event loop itself, as sockets are relatively low-level objects.</p></div><div class="el-p"><p dir="auto">More event loop methods (II):</p></div><div class="el-ol"><ol>
<li data-line="0" dir="auto">await loop.sock_accept(socket) — coroutine, returns <code class="code-styler-inline">connection_socket</code>, <code class="code-styler-inline">connection_address</code>.</li>
<li data-line="1" dir="auto">await loop.sock_recv(socket, n) — coroutine, returns the incoming data.</li>
<li data-line="2" dir="auto">await loop.sock_sendall(socket, data) — coroutine, sends data and returns <code class="code-styler-inline">None</code> if everything is okay.</li>
</ol></div><div class="el-p"><p dir="auto">Signals — a mechanism for asynchronous notification of processes about events happening at the OS level. Examples:</p></div><div class="el-ul"><ul class="has-list-bullet">
<li data-line="0" dir="auto"><span class="list-bullet"></span>SIGINT — interruption signal, when pressing <code class="code-styler-inline">^C</code>.</li>
<li data-line="1" dir="auto"><span class="list-bullet"></span>SIGTERM — termination signal, when a process is killed via <code class="code-styler-inline">kill</code>.</li>
</ul></div><div class="el-p"><p dir="auto">More event loop methods (III):</p></div><div class="el-ol"><ol>
<li data-line="0" dir="auto">loop.add_signal_handler(type, func) — add a signal handler.<br>
This is different from the unsafe (relative to the event loop) method:</li>
</ol></div><div class="el-pre code-styler-pre-parent"><pre class="language-python"><code data-line="0" class="language-python is-loaded">signal<span class="token punctuation">.</span>signal<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Get a set of all running tasks:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">asyncio<span class="token punctuation">.</span>all_tasks<span class="token punctuation">(</span><span class="token punctuation">)</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h1"><h1 data-heading="Chapter IV: Concurrent Web Requests" dir="auto" class="heading" id="Chapter_IV_Concurrent_Web_Requests_0"><span class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></span>Chapter IV: Concurrent Web Requests</h1></div><div class="el-p"><p dir="auto">HTTP libraries:</p></div><div class="el-ul"><ul class="has-list-bullet">
<li data-line="0" dir="auto"><span class="list-bullet"></span>requests — blocking, not compatible with asyncio.</li>
<li data-line="1" dir="auto"><span class="list-bullet"></span>aiohttp — asynchronous, compatible with asyncio and uses non-blocking sockets.</li>
</ul></div><div class="el-p"><p dir="auto">Asynchronous context manager:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text"><span class="token keyword">async</span> <span class="token keyword">with</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Used for objects implementing:</p></div><div class="el-ul"><ul class="has-list-bullet">
<li data-line="0" dir="auto"><span class="list-bullet"></span><strong>aenter</strong> (async enter)</li>
<li data-line="1" dir="auto"><span class="list-bullet"></span><strong>aexit</strong> (async exit)</li>
</ul></div><div class="el-p"><p dir="auto">When working with web connections, the concept of a <em>session</em> is used. Cookies and open connections are stored in the session. A connection pool is very important because creating them is an expensive procedure.</p></div><div class="el-p"><p dir="auto">Creating an asynchronous HTTP client:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text"><span class="token keyword">with</span> aiohttp<span class="token punctuation">.</span>ClientSession<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">A GET request returns a result that also needs to be closed (released), so we use it within an async context manager as well:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text"><span class="token keyword">with</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token keyword">as</span> result<span class="token punctuation">:</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">By default, a session is limited to creating 100 connections. This number can be changed using <code class="code-styler-inline">aiohttp.TCPConnector</code> passed to <code class="code-styler-inline">aiohttp.ClientSession</code>.</p></div><div class="el-p"><p dir="auto">To run and handle a dynamic (determined at runtime) number of tasks, you should use asyncio tools!</p></div><div class="el-p"><p dir="auto">Useful asyncio methods for multiple executions:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text"><span class="token comment"># 1</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text">asyncio<span class="token punctuation">.</span>gather<span class="token punctuation">(</span><span class="token operator">*</span>awaitables<span class="token punctuation">,</span> return_exceptions<span class="token operator">=</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-ul"><ul class="has-list-bullet">
<li data-line="0" dir="auto"><span class="list-bullet"></span>Returns an awaitable.</li>
<li data-line="1" dir="auto"><span class="list-bullet"></span>Wraps coroutines into tasks and starts all tasks. When awaited, it concurrently waits for all tasks to complete and returns a list of results!</li>
<li data-line="2" dir="auto"><span class="list-bullet"></span>The order of results corresponds to the order of the passed coroutines, but the order of their execution (receiving results) is non-deterministic.</li>
<li data-line="3" dir="auto"><span class="list-bullet"></span><code class="code-styler-inline">return_exceptions=False</code> (default) immediately raises the first exception that occurs; if <code class="code-styler-inline">True</code>, exceptions are returned in the result list (according to the order).</li>
</ul></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text"><span class="token comment"># 2</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text">asyncio<span class="token punctuation">.</span>as_completed<span class="token punctuation">(</span>awaitables<span class="token punctuation">,</span> timeout<span class="token punctuation">:</span> <span class="token builtin">float</span><span class="token punctuation">)</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-ul"><ul class="has-list-bullet">
<li data-line="0" dir="auto"><span class="list-bullet"></span>Returns an iterator where each subsequent object is an awaitable. When a coroutine is ready, it returns its result upon being awaited.</li>
<li data-line="1" dir="auto"><span class="list-bullet"></span>An exception will be thrown at the <code class="code-styler-inline">await</code> point of the next iterator object, which is convenient for immediate handling.</li>
<li data-line="2" dir="auto"><span class="list-bullet"></span>The timeout is set for all passed coroutines. Once time expires, all subsequent awaits on tasks will raise a <code class="code-styler-inline">TimeoutException</code>.</li>
</ul></div><div class="el-p"><p dir="auto">The <code class="code-styler-inline">gather</code> and <code class="code-styler-inline">as_completed</code> methods have one common drawback: it's difficult to cancel tasks that are still running when an exception occurs. The <code class="code-styler-inline">wait</code> method comes to the rescue:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text"><span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>wait<span class="token punctuation">(</span>futures_iterable<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">,</span> timeout<span class="token punctuation">,</span> return_when<span class="token punctuation">)</span>  <span class="token comment"># -&gt; Tuple[Set, Set]</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-ul"><ul class="has-list-bullet">
<li data-line="0" dir="auto"><span class="list-bullet"></span>Accepts an iterable of Futures. These should be coroutines already wrapped in tasks; otherwise, it will wrap them itself (in old versions), leading to potential <code class="code-styler-inline">is</code> comparison errors, or in new versions, it will raise a <code class="code-styler-inline">TypeError</code>.</li>
<li data-line="1" dir="auto"><span class="list-bullet"></span>Returns 2 sets: <code class="code-styler-inline">(done, pending)</code> — finished (normally or with an exception) and still active tasks.</li>
<li data-line="2" dir="auto"><span class="list-bullet"></span><code class="code-styler-inline">timeout</code> does not raise exceptions, unlike <code class="code-styler-inline">as_completed</code>.</li>
<li data-line="3" dir="auto"><span class="list-bullet"></span><code class="code-styler-inline">return_when</code> is set to one of: <u>ALL_COMPLETED</u>, FIRST_EXCEPTION, or FIRST_COMPLETED.</li>
</ul></div><div class="el-h1"><h1 data-heading="Chapter V: Non-blocking DB Drivers" dir="auto" class="heading" id="Chapter_V_Non-blocking_DB_Drivers_0"><span class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></span>Chapter V: Non-blocking DB Drivers</h1></div><div class="el-p"><p dir="auto">Non-blocking APIs for concurrent DB access:</p></div><div class="el-ul"><ul class="has-list-bullet">
<li data-line="0" dir="auto"><span class="list-bullet"></span>aiomysql, implements PEP-249.</li>
<li data-line="1" dir="auto"><span class="list-bullet"></span>asyncpg (asynchronous PostgreSQL or postgres), deliberately does not implement PEP-249.</li>
</ul></div><div class="el-p"><p dir="auto">Connection/Disconnection:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">connection <span class="token operator">=</span> <span class="token keyword">await</span> asyncpg<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text"><span class="token keyword">await</span> connection<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Connection object methods:<br>
Execute a query:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text"><span class="token keyword">await</span> connection<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>query<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>  <span class="token comment"># -&gt; status:str</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Execute a query and return values:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text"><span class="token keyword">await</span> connection<span class="token punctuation">.</span>fetch<span class="token punctuation">(</span>query<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>  <span class="token comment"># -&gt; List[asyncpg.Record]</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-ul"><ul class="has-list-bullet">
<li data-line="0" dir="auto"><span class="list-bullet"></span>Arguments for $1, $2, etc., can be passed here.</li>
</ul></div><div class="el-ol"><ol>
<li data-line="0" dir="auto">Fetch only 1 row:</li>
</ol></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text"><span class="token keyword">await</span> connection<span class="token punctuation">.</span>fetchrow<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-ul"><ul class="has-list-bullet">
<li data-line="0" dir="auto"><span class="list-bullet"></span>same regarding $1, $2, etc.</li>
</ul></div><div class="el-ol"><ol>
<li data-line="0" dir="auto">Run a parameterized command:</li>
</ol></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text"><span class="token keyword">await</span> connection<span class="token punctuation">.</span>executemany<span class="token punctuation">(</span>query<span class="token punctuation">,</span> args<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">runs the query, replacing $1, $2, and so on with elements from the first tuple in <code class="code-styler-inline">args</code>, then the second, and so on…</p></div><div class="el-p"><p dir="auto">One DB connection corresponds to <strong>one</strong> socket! To work concurrently, you need multiple connections. Since creating them is expensive, they are usually cached; such a cache is called a:<br>
<em>connection pool.</em></p></div><div class="el-p"><p dir="auto">Creating a pool:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text"><span class="token keyword">async</span> <span class="token keyword">with</span> asyncpg<span class="token punctuation">.</span>create_pool<span class="token punctuation">(</span>min_size<span class="token punctuation">,</span> max_size<span class="token punctuation">,</span> <span class="token operator">**</span>connection_kwargs<span class="token punctuation">)</span> <span class="token keyword">as</span> pool<span class="token punctuation">:</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Acquiring a connection:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">    <span class="token keyword">async</span> <span class="token keyword">with</span> pool<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> connection<span class="token punctuation">:</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">You can execute a query without explicitly acquiring a connection by using the pool directly:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">result <span class="token operator">=</span> <span class="token keyword">await</span> pool<span class="token punctuation">.</span>fetch<span class="token punctuation">(</span>query<span class="token punctuation">)</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Closing the pool if it wasn't created via <code class="code-styler-inline">async with</code>:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text"><span class="token keyword">await</span> pool<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto"><u>TRANSACTIONS.</u><br>
ACID (atomicity, consistency, isolation, durability).<br>
Transactions are a key concept in many ACID-compliant databases.<br>
A DB transaction is one or more SQL commands executed as an indivisible whole. If <u>everything</u> is successful, the result is <em>committed</em>; otherwise, it is <em>rolled back</em>.</p></div><div class="el-p"><p dir="auto">A simple way to execute a transaction:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text"><span class="token keyword">async</span> <span class="token keyword">with</span> connection<span class="token punctuation">.</span>transaction<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text">    <span class="token keyword">await</span> <span class="token operator">&lt;</span>do some SQL command<span class="token operator">&gt;</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">3</div><div class="code-styler-line-text">    <span class="token keyword">await</span> <span class="token operator">&lt;</span>do some SQL command<span class="token operator">&gt;</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">4</div><div class="code-styler-line-text"><span class="token comment"># if no exception occurs — commit changes!</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">5</div><div class="code-styler-line-text"><span class="token comment"># if any exception occurs — roll back changes!</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">! asyncpg supports nested transactions (<code class="code-styler-inline">async with</code> inside <code class="code-styler-inline">async with</code>).</p></div><div class="el-p"><p dir="auto">Transactions can be managed manually. Getting a transaction manager:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">transaction<span class="token punctuation">:</span> asyncpg<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span>Transaction <span class="token operator">=</span> connection<span class="token punctuation">.</span>transaction<span class="token punctuation">(</span><span class="token punctuation">)</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Transaction object methods:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text"><span class="token keyword">await</span> transaction<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text"><span class="token keyword">await</span> transaction<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">3</div><div class="code-styler-line-text"><span class="token keyword">await</span> transaction<span class="token punctuation">.</span>rollback<span class="token punctuation">(</span><span class="token punctuation">)</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Asynchronous generators:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">async_generator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text">    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">3</div><div class="code-styler-line-text">    <span class="token keyword">await</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">4</div><div class="code-styler-line-text">    <span class="token keyword">yield</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">How to iterate through an entire async generator:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text"><span class="token keyword">async</span> <span class="token keyword">for</span> element <span class="token keyword">in</span> async_generator<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text">    <span class="token keyword">print</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">If you need to retrieve elements manually:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">gen <span class="token operator">=</span> async_generator<span class="token punctuation">(</span><span class="token punctuation">)</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text"><span class="token keyword">await</span> anext<span class="token punctuation">(</span>gen<span class="token punctuation">)</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">3</div><div class="code-styler-line-text"><span class="token keyword">await</span> anext<span class="token punctuation">(</span>gen<span class="token punctuation">)</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">4</div><div class="code-styler-line-text"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">By the way!! This <code class="code-styler-inline">async for</code> loop is also available in comprehensions!:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text"><span class="token punctuation">[</span>x <span class="token keyword">async</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> get_async_generator<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Using a cursor (to get an async generator for streaming SQL query results) also requires opening a transaction:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text"><span class="token keyword">async</span> <span class="token keyword">with</span> connection<span class="token punctuation">.</span>transaction<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text">    <span class="token keyword">async</span> <span class="token keyword">for</span> el <span class="token keyword">in</span> connection<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span>query<span class="token punctuation">,</span> prefetch<span class="token operator">=</span><span class="token punctuation">)</span><span class="token punctuation">:</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">3</div><div class="code-styler-line-text">        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">4</div><div class="code-styler-line-text"><br></div></div><div class="code-styler-line"><div class="code-styler-line-number">5</div><div class="code-styler-line-text">OR</div></div><div class="code-styler-line"><div class="code-styler-line-number">6</div><div class="code-styler-line-text"><br></div></div><div class="code-styler-line"><div class="code-styler-line-number">7</div><div class="code-styler-line-text"><span class="token keyword">async</span> <span class="token keyword">with</span> connection<span class="token punctuation">.</span>transaction<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">8</div><div class="code-styler-line-text">    cursor <span class="token operator">=</span> <span class="token keyword">await</span> connection<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span>query<span class="token punctuation">)</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-ul"><ul class="has-list-bullet">
<li data-line="0" dir="auto"><span class="list-bullet"></span><code class="code-styler-inline">prefetch</code> — the number of records to load into RAM per iteration.</li>
</ul></div><div class="el-p"><p dir="auto">Cursor methods:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text"><span class="token comment"># 1</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text"><span class="token keyword">await</span> cursor<span class="token punctuation">.</span>fetch<span class="token punctuation">(</span>n<span class="token punctuation">)</span>  <span class="token comment"># take n elements into RAM</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">3</div><div class="code-styler-line-text"><br></div></div><div class="code-styler-line"><div class="code-styler-line-number">4</div><div class="code-styler-line-text"><span class="token comment"># 2</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">5</div><div class="code-styler-line-text"><span class="token keyword">await</span> cursor<span class="token punctuation">.</span>forward<span class="token punctuation">(</span>n<span class="token punctuation">)</span>  <span class="token comment"># skip n elements</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Moving forward <strong>and backward</strong> through a selection is possible when explicitly using the query:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">DECLARE <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> SCROLL CURSOR</div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Library for working with async generators:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">    aiostream</div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h1"><h1 data-heading="Chapter VI: CPU-bound Tasks" dir="auto" class="heading" id="Chapter_VI_CPU-bound_Tasks_0"><span class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></span>Chapter VI: CPU-bound Tasks</h1></div><div class="el-p"><p dir="auto">You can bypass the GIL and execute CPU-bound tasks concurrently in Python! For this, the following library is used:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">    multiprocessing</div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Working with a process:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">task <span class="token operator">=</span> multiprocessing<span class="token punctuation">.</span>Process<span class="token punctuation">(</span>target<span class="token operator">=</span><span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">,</span><span class="token punctuation">)</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text">task<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">3</div><div class="code-styler-line-text"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">4</div><div class="code-styler-line-text">task<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">The use of the <code class="code-styler-inline">if __name__ == '__main__':</code> construct is mandatory; otherwise, you will get an error:<br>
"An attempt has been made to start a new process before the current process has finished its bootstrapping phase."</p></div><div class="el-p"><p dir="auto">Creating a process pool:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text"><span class="token keyword">with</span> multiprocessing<span class="token punctuation">.</span>Pool<span class="token punctuation">(</span>processes<span class="token operator">=</span><span class="token operator">&lt;</span>defaults to multiprocessing<span class="token punctuation">.</span>cpu_count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> process_pool<span class="token punctuation">:</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text">    result <span class="token operator">=</span> process_pool<span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span>target_func<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">)</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">3</div><div class="code-styler-line-text">    <span class="token keyword">print</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">You can also apply functions in a process pool asynchronously, though these are not yet awaitable objects:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">    task <span class="token operator">=</span> process_pool<span class="token punctuation">.</span>apply_async<span class="token punctuation">(</span>target_func<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">)</span>  <span class="token comment"># non-blocking</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text">    result <span class="token operator">=</span> task<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># blocking</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto"><u>Process Pool Executors</u><br>
A module offering an abstraction over process pools:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">concurrent<span class="token punctuation">.</span>futures</div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">The abstract class <code class="code-styler-inline">Executor</code> represents an abstraction of an executor with a certain pool of resources. Depending on the type of resource, there are:</p></div><div class="el-ul"><ul class="has-list-bullet">
<li data-line="0" dir="auto"><span class="list-bullet"></span>ProcessPoolExecutor</li>
<li data-line="1" dir="auto"><span class="list-bullet"></span>ThreadPoolExecutor</li>
</ul></div><div class="el-p"><p dir="auto">Executor methods:</p></div><div class="el-ol"><ol>
<li data-line="0" dir="auto">submit</li>
</ol></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">Executor<span class="token punctuation">.</span>submit<span class="token punctuation">(</span>fn<span class="token punctuation">,</span> <span class="token operator">/</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Future</div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-ul"><ul class="has-list-bullet">
<li data-line="0" dir="auto"><span class="list-bullet"></span>The returned Future is different from the one in asyncio.</li>
<li data-line="1" dir="auto"><span class="list-bullet"></span>It is analogous to <code class="code-styler-inline">multiprocessing.Pool.apply_async</code>.</li>
</ul></div><div class="el-ol"><ol>
<li data-line="0" dir="auto">map</li>
</ol></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">Executor<span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> <span class="token operator">*</span>iterables<span class="token punctuation">,</span> timeout<span class="token punctuation">,</span> chunksize<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Iterator</div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-ul"><ul class="has-list-bullet">
<li data-line="0" dir="auto"><span class="list-bullet"></span>It is analogous to <code class="code-styler-inline">asyncio.as_completed</code>.</li>
<li data-line="1" dir="auto"><span class="list-bullet"></span>But this analogy only holds in that results arrive as they are ready; however, they arrive IN THE SAME ORDER as the <code class="code-styler-inline">iterables</code>. This means even if tasks run in parallel, you have to wait for results in sequence (i.e., if a long operation comes first, you won't get the results of fast operations even if they are already done).</li>
</ul></div><div class="el-p"><p dir="auto">Creating a process pool executor:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text"><span class="token keyword">import</span> concurrent<span class="token punctuation">.</span>futures <span class="token keyword">as</span> concfu</div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text"><br></div></div><div class="code-styler-line"><div class="code-styler-line-number">3</div><div class="code-styler-line-text"><span class="token keyword">with</span> concfu<span class="token punctuation">.</span>ProcessPoolExecutor<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> process_pool<span class="token punctuation">:</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">4</div><div class="code-styler-line-text">    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">USEFUL: partial function application:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">functools<span class="token punctuation">.</span>partial<span class="token punctuation">(</span>some_func<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>  <span class="token comment"># returns a function equivalent to the following:</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text"><span class="token keyword">def</span> <span class="token function">result_func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">3</div><div class="code-styler-line-text">    <span class="token keyword">return</span> some_func<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">How to link a process pool executor to asyncio:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">event_loop<span class="token punctuation">.</span>run_in_executor<span class="token punctuation">(</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text">    process_pool<span class="token punctuation">,</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">3</div><div class="code-styler-line-text">    functools<span class="token punctuation">.</span>partial<span class="token punctuation">(</span>count<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">,</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">4</div><div class="code-styler-line-text"><span class="token punctuation">)</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-ul"><ul class="has-list-bullet">
<li data-line="0" dir="auto"><span class="list-bullet"></span>This returns an awaitable object that can be used, for example, in <code class="code-styler-inline">asyncio.gather</code>.</li>
<li data-line="1" dir="auto"><span class="list-bullet"></span>Note: the second argument is a function WITHOUT arguments! <b><u>UPD</u></b> This seems to be an error; arguments can be passed further.</li>
<li data-line="2" dir="auto"><span class="list-bullet"></span>The method belongs to the event loop class, not the asyncio module!</li>
<li data-line="3" dir="auto"><span class="list-bullet"></span>Even with this approach, you MUST use <code class="code-styler-inline">if __name__ == '__main__':</code>.</li>
</ul></div><div class="el-p"><p dir="auto">Interesting! Real BigData systems for cluster (group of computers) computing:</p></div><div class="el-ul"><ul class="has-list-bullet">
<li data-line="0" dir="auto"><span class="list-bullet"></span>Hadoop</li>
<li data-line="1" dir="auto"><span class="list-bullet"></span>Spark</li>
</ul></div><div class="el-p"><p dir="auto"><u>Definition</u>:<br>
&gt; An n-gram is a sequence of n consecutive words in a text.<br>
Example:<br>
Text: "The quick ball flies"</p></div><div class="el-ul"><ul class="has-list-bullet">
<li data-line="0" dir="auto"><span class="list-bullet"></span>1-grams: (The), (Quick), (Ball), (Flies)</li>
<li data-line="1" dir="auto"><span class="list-bullet"></span>2-grams: (The quick), (Quick ball), (Ball flies)</li>
<li data-line="2" dir="auto"><span class="list-bullet"></span>3-grams: (The quick ball), (Quick ball flies)</li>
<li data-line="3" dir="auto"><span class="list-bullet"></span>4-grams: (The quick ball flies)</li>
</ul></div><div class="el-p"><p dir="auto"><u>Shared data and locks.</u><br>
The <code class="code-styler-inline">multiprocessing</code> library supports <em>shared memory objects</em>. Types of shared data:</p></div><div class="el-ol"><ol>
<li data-line="0" dir="auto">Value</li>
<li data-line="1" dir="auto">Array<br>
Only types described in the <a data-tooltip-position="top" aria-label="https://docs.python.org/3/library/array.html#module-array" rel="noopener nofollow" class="external-link is-unresolved" href="https://docs.python.org/3/library/array.html#module-array" target="_self">array module</a> are allowed for storage.</li>
</ol></div><div class="el-p"><p dir="auto">Creation example:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text"><span class="token keyword">import</span> multiprocessing <span class="token keyword">as</span> mp</div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text"><br></div></div><div class="code-styler-line"><div class="code-styler-line-number">3</div><div class="code-styler-line-text">number <span class="token operator">=</span> mp<span class="token punctuation">.</span>Value<span class="token punctuation">(</span><span class="token string">'i'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">4</div><div class="code-styler-line-text">intarray <span class="token operator">=</span> mp<span class="token punctuation">.</span>Array<span class="token punctuation">(</span><span class="token string">'i'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">5</div><div class="code-styler-line-text"><br></div></div><div class="code-styler-line"><div class="code-styler-line-number">6</div><div class="code-styler-line-text"><span class="token comment"># these objects can be passed to processes as arguments!</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">7</div><div class="code-styler-line-text"><br></div></div><div class="code-styler-line"><div class="code-styler-line-number">8</div><div class="code-styler-line-text">mp<span class="token punctuation">.</span>Process<span class="token punctuation">(</span>target<span class="token operator">=</span>some_func<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>number<span class="token punctuation">,</span> intarray<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto"><u>Definition:</u><br>
<em>Race condition</em> — a situation where the outcome of a sequence of operations depends on which operation finishes first.</p></div><div class="el-p"><p dir="auto">Atomic and non-atomic operations in Python are described <a data-tooltip-position="top" aria-label="http://mng.bz/5Kj4" rel="noopener nofollow" class="external-link is-unresolved" href="http://mng.bz/5Kj4" target="_self">here</a>.</p></div><div class="el-p"><p dir="auto">To <em>synchronize</em> access to shared data, <em>locks</em> (also known as <em>mutexes</em>) are used. The section of code subject to a lock is called a <em>critical section</em>.<br>
Mutex operations:</p></div><div class="el-ul"><ul class="has-list-bullet">
<li data-line="0" dir="auto"><span class="list-bullet"></span>acquire</li>
<li data-line="1" dir="auto"><span class="list-bullet"></span>release</li>
</ul></div><div class="el-p"><p dir="auto">To acquire a lock in <code class="code-styler-inline">multiprocessing</code>:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">x<span class="token punctuation">:</span> mp<span class="token punctuation">.</span>Value <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text">x<span class="token punctuation">.</span>get_lock<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">3</div><div class="code-styler-line-text"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">4</div><div class="code-styler-line-text">x<span class="token punctuation">.</span>get_lock<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Or like this:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text"><span class="token keyword">with</span> x<span class="token punctuation">.</span>get_lock<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text">    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Important!<br>
A process pool maintains a task queue; arguments are serialized and placed in the queue. (<b><u>UPD</u></b> It should also be noted that return values are also serialized!) This prevents us from passing shared <code class="code-styler-inline">mp.Value</code> and <code class="code-styler-inline">mp.Array</code> as arguments to the pool because they are NOT serializable. In this case, we use:<br>
<em>Process Pool Initializers</em></p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text"><span class="token keyword">with</span> concfu<span class="token punctuation">.</span>ProcessPoolExecutor<span class="token punctuation">(</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text">    initializer<span class="token operator">=</span>init_func<span class="token punctuation">,</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">3</div><div class="code-styler-line-text">    initargs<span class="token operator">=</span><span class="token punctuation">(</span>arg1<span class="token punctuation">,</span> arg2<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">,</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">4</div><div class="code-styler-line-text"><span class="token punctuation">)</span> <span class="token keyword">as</span> pool<span class="token punctuation">:</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">5</div><div class="code-styler-line-text">    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Here, <code class="code-styler-inline">initargs</code> are NOT serialized! This is exactly what is needed.</p></div><div class="el-p"><p dir="auto">Important!<br>
When each process is created, the script that creates it is executed anew! This is why initializers are needed (and it's the same reason why we are required to use the <code class="code-styler-inline">if __name__ == '__main__':</code> construct).</p></div><div class="el-p"><p dir="auto"><u>Culmination</u>: You can use multiple event loops across processes (e.g., multiple DB connection pools), which allows increasing application throughput for workloads containing both CPU-bound and I/O-bound tasks. Example:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text"><span class="token comment"># pseudocode</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text"><br></div></div><div class="code-styler-line"><div class="code-styler-line-number">3</div><div class="code-styler-line-text"><span class="token keyword">def</span> <span class="token function">task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">4</div><div class="code-styler-line-text">    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">sub_main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">5</div><div class="code-styler-line-text">        <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>gather<span class="token punctuation">(</span><span class="token operator">*</span>sub_tasks<span class="token punctuation">)</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">6</div><div class="code-styler-line-text">    </div></div><div class="code-styler-line"><div class="code-styler-line-number">7</div><div class="code-styler-line-text">    asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>sub_main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">8</div><div class="code-styler-line-text"><br></div></div><div class="code-styler-line"><div class="code-styler-line-number">9</div><div class="code-styler-line-text"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">10</div><div class="code-styler-line-text">    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>gather<span class="token punctuation">(</span><span class="token operator">*</span>tasks<span class="token punctuation">)</span>  <span class="token comment"># where 1 task in the process pool is something like the logic above ☝🏼</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">11</div><div class="code-styler-line-text"><br></div></div><div class="code-styler-line"><div class="code-styler-line-number">12</div><div class="code-styler-line-text">asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h1"><h1 data-heading="Chapter VII: Solving Blocking Issues with Threads" dir="auto" class="heading" id="Chapter_VII_Solving_Blocking_Issues_with_Threads_0"><span class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></span>Chapter VII: Solving Blocking Issues with Threads</h1></div><div class="el-p"><p dir="auto">There is a lot of legacy code using <code class="code-styler-inline">requests</code>, <code class="code-styler-inline">psycopg</code>, or other libraries incompatible with <code class="code-styler-inline">asyncio</code>. In such cases, multithreading comes to the rescue!<br>
Blocking I/O operations release the GIL!</p></div><div class="el-p"><p dir="auto">You can simply create a multithreaded echo server by creating child threads for echo tasks. However, the first difficulty arises here: an interruption (<code class="code-styler-inline">^C</code>) will only stop the parent thread, while child threads will continue to execute.</p></div><div class="el-p"><p dir="auto">You can:</p></div><div class="el-ol"><ol>
<li data-line="0" dir="auto">Make child threads daemons (though such threads terminate abruptly, which doesn't allow for proper cleanup). Example: <code class="code-styler-inline">thread.daemon = True</code></li>
<li data-line="1" dir="auto">Implement your own logic for interrupting child threads.</li>
</ol></div><div class="el-p"><p dir="auto">The correct way to terminate child threads would be:<br>
Inherit from <code class="code-styler-inline">th.Thread</code> and write your own <code class="code-styler-inline">.run()</code> and <code class="code-styler-inline">.close()</code> methods. The former is called automatically when <code class="code-styler-inline">.start()</code> is invoked, and the latter is called manually during shutdown. At the moment of <code class="code-styler-inline">.shutdown()</code>, <code class="code-styler-inline">.recv()</code> returns an empty result, and <code class="code-styler-inline">.sendall()</code> raises an <code class="code-styler-inline">OSError</code>. For empty results, a <code class="code-styler-inline">BrokenPipeError</code> (a subclass of <code class="code-styler-inline">OSError</code>) should be raised.</p></div><div class="el-p"><p dir="auto">Reminder: When reading with <code class="code-styler-inline">.recv()</code>, a value of 0 may be received if the connection was closed (by either the client or the server).</p></div><div class="el-p"><p dir="auto">Thread methods:</p></div><div class="el-ol"><ol>
<li data-line="0" dir="auto"><code class="code-styler-inline">is_alive()</code></li>
</ol></div><div class="el-p"><p dir="auto">Two ways of manual thread management:</p></div><div class="el-ol"><ol>
<li data-line="0" dir="auto">Explicitly creating <code class="code-styler-inline">th.Thread</code> with a target function.</li>
<li data-line="1" dir="auto">Inheriting <code class="code-styler-inline">class MyThread(th.Thread)</code> and overriding <code class="code-styler-inline">.run()</code>.</li>
</ol></div><div class="el-p"><p dir="auto">Multithreaded execution is still slower than multiprocess execution. This is because creating and maintaining threads (context switching) is more expensive for the operating system!!</p></div><div class="el-p"><p dir="auto">You can omit the executor in the <code class="code-styler-inline">event_loop.run_in_executor()</code> call:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">event_loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_running_loop<span class="token punctuation">(</span><span class="token punctuation">)</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text">task <span class="token operator">=</span> event_loop<span class="token punctuation">.</span>run_in_executor<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> func<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">In this case, <code class="code-styler-inline">concfu.ThreadPoolExecutor()</code> will be used by default.</p></div><div class="el-ul"><ul class="has-list-bullet">
<li data-line="0" dir="auto"><span class="list-bullet"></span>Note that such a pool will only be terminated when the event loop exits, which usually happens only when the program finishes. The pool remains cached.</li>
</ul></div><div class="el-p"><p dir="auto">You can go even further using the newer <code class="code-styler-inline">asyncio</code> function:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">task <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>to_thread<span class="token punctuation">(</span>func<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Obviously: Threads have access to shared memory, so shared memory objects (<code class="code-styler-inline">mt.Value</code> / <code class="code-styler-inline">mt.Array</code>) are not needed. However, locks are still required:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text"><span class="token keyword">import</span> threading <span class="token keyword">as</span> th</div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text">th<span class="token punctuation">.</span>Lock<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># supports: .acquire(), .release(), with statement</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Reentrant lock:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">th<span class="token punctuation">.</span>RLock</div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-ul"><ul class="has-list-bullet">
<li data-line="0" dir="auto"><span class="list-bullet"></span>Allows being re-acquired by the same thread.</li>
<li data-line="1" dir="auto"><span class="list-bullet"></span>Under the hood, such a mutex stores an acquisition counter: +1 when acquired and -1 when released. When it hits 0, another thread can acquire the lock.</li>
</ul></div><div class="el-p"><p dir="auto">Reentrant locks are mostly needed when two methods acquire a lock, and one of them calls the other.</p></div><div class="el-p"><p dir="auto">The DRY principle (Don't Repeat Yourself).</p></div><div class="el-p"><p dir="auto"><u>Definition</u>:<br>
<em>Deadlock</em> — a situation where several threads are waiting for locks held by each other.<br>
Ways to avoid deadlock:</p></div><div class="el-ol"><ol>
<li data-line="0" dir="auto">"Ostrich algorithm" — assume a deadlock won't happen or just restart the program if it does. A poor choice.</li>
<li data-line="1" dir="auto">Proper design: Use a consistent locking order or only a single lock.</li>
</ol></div><div class="el-p"><p dir="auto">Tkinter — a cross-platform library for building GUIs.</p></div><div class="el-ul"><ul class="has-list-bullet">
<li data-line="0" dir="auto"><span class="list-bullet"></span>The name comes from "Tk interface," meaning it's an interface to the low-level Tk library written in Tcl.</li>
<li data-line="1" dir="auto"><span class="list-bullet"></span>This library (like many other GUI libs) is based on widgets and its own event loop.</li>
</ul></div><div class="el-p"><p dir="auto">It's important to understand that passing functions/calls between two event loops in different threads is a dangerous procedure, and you must watch out for race conditions (look for thread-safe methods).<br>
Thread-safe <code class="code-styler-inline">asyncio</code> tools:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text"><span class="token comment"># 1</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text">event_loop<span class="token punctuation">.</span>call_soon_threadsafe<span class="token punctuation">(</span>func<span class="token punctuation">)</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-ul"><ul class="has-list-bullet">
<li data-line="0" dir="auto"><span class="list-bullet"></span>Thread-safely schedules the execution of a function (not a coroutine) on the next iteration of the event loop.</li>
</ul></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text"><span class="token comment"># 2</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text">asyncio<span class="token punctuation">.</span>run_coroutine_threadsafe<span class="token punctuation">(</span>coroutine<span class="token punctuation">)</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-ul"><ul class="has-list-bullet">
<li data-line="0" dir="auto"><span class="list-bullet"></span>Thread-safely schedules the execution of a coroutine.</li>
<li data-line="1" dir="auto"><span class="list-bullet"></span>Returns a <code class="code-styler-inline">Future</code> object (<code class="code-styler-inline">concurrent.futures</code>, not <code class="code-styler-inline">asyncio</code>, though their interfaces are similar).</li>
</ul></div><div class="el-p"><p dir="auto">One pattern for executing a callback function in the main thread is using a thread-safe queue!</p></div><div class="el-p"><p dir="auto">Another event loop method with a self-explanatory name:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">event_loop<span class="token punctuation">.</span>run_forever<span class="token punctuation">(</span><span class="token punctuation">)</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Some CPU-bound workloads can also release the GIL because they do NOT interact with Python objects but compute at a low level (often C code).<br>
Examples of libraries that compute in C and therefore release the GIL:</p></div><div class="el-ul"><ul class="has-list-bullet">
<li data-line="0" dir="auto"><span class="list-bullet"></span>hashlib</li>
<li data-line="1" dir="auto"><span class="list-bullet"></span>numpy</li>
</ul></div><div class="el-p"><p dir="auto">KEY IDEA: Multithreaded execution of CPU-bound tasks that release the GIL provides a performance gain!!</p></div><div class="el-p"><p dir="auto">Hashed data cannot be read or recovered, but you can verify that data matches the hash (checksum).<br>
Some well-known hashing algorithms:</p></div><div class="el-ul"><ul class="has-list-bullet">
<li data-line="0" dir="auto"><span class="list-bullet"></span>SHA512</li>
<li data-line="1" dir="auto"><span class="list-bullet"></span>BLAKE2</li>
<li data-line="2" dir="auto"><span class="list-bullet"></span>scrypt</li>
</ul></div><div class="el-p"><p dir="auto">The <code class="code-styler-inline">scrypt</code> algorithm uses a <em>salt</em> and is considered a secure choice for password hashing.</p></div><div class="el-p"><p dir="auto">NumPy Tip: A significant performance boost comes from maximal code vectorization (avoiding Python loops or functions like <code class="code-styler-inline">apply_along_axis</code> that hide a loop).</p></div><div class="el-h1"><h1 data-heading="Chapter VIII: Data Streams" dir="auto" class="heading" id="Chapter_VIII_Data_Streams_0"><span class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></span>Chapter VIII: Data Streams</h1></div><div class="el-p"><p dir="auto">Stream APIs are built on top of low-level <em>transport</em> and <em>protocol</em> APIs. These stream APIs are designed differently: there is no active waiting; instead, the library calls a callback method when data is ready. Let's look at those first:</p></div><div class="el-p"><p dir="auto">How is it organized in terms of low-level vs high-level?<br>
Socket, Selector —&gt; Transport, Protocol —&gt; Data stream</p></div><div class="el-p"><p dir="auto">Previously we worked with sockets and selectors; now we'll show how to work with Transport and Protocol (which actually work together; a Protocol is created to communicate automatically with a Transport). Although in the future, we will use data streams!<br>
First, a subclass of <code class="code-styler-inline">asyncio.Protocol</code> is created:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text"><span class="token keyword">class</span> <span class="token class-name">MyProtocol</span><span class="token punctuation">(</span>asyncio<span class="token punctuation">.</span>Protocol<span class="token punctuation">)</span><span class="token punctuation">:</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text"><br></div></div><div class="code-styler-line"><div class="code-styler-line-number">3</div><div class="code-styler-line-text">    <span class="token keyword">def</span> <span class="token function">connection_made</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> transport<span class="token punctuation">:</span> asyncio<span class="token punctuation">.</span>Transport<span class="token punctuation">)</span><span class="token punctuation">:</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">4</div><div class="code-styler-line-text">        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  <span class="token comment"># Transport calls this when the socket is successfully connected</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">5</div><div class="code-styler-line-text">        transport<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token builtin">bytes</span><span class="token punctuation">)</span>  <span class="token comment"># We can send bytes</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">6</div><div class="code-styler-line-text">    </div></div><div class="code-styler-line"><div class="code-styler-line-number">7</div><div class="code-styler-line-text">    <span class="token keyword">def</span> <span class="token function">data_received</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">8</div><div class="code-styler-line-text">        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  <span class="token comment"># Transport calls this EVERY TIME data arrives</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">9</div><div class="code-styler-line-text">        self<span class="token punctuation">.</span>_buffer <span class="token operator">+=</span> data  <span class="token comment"># Usually, data is accumulated in a buffer here</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">10</div><div class="code-styler-line-text"><br></div></div><div class="code-styler-line"><div class="code-styler-line-number">11</div><div class="code-styler-line-text">    <span class="token keyword">def</span> <span class="token function">eof_received</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> tp<span class="token punctuation">.</span>Optional<span class="token punctuation">[</span><span class="token builtin">bool</span><span class="token punctuation">]</span><span class="token punctuation">:</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">12</div><div class="code-styler-line-text">        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  <span class="token comment"># Transport calls this when EOF is received (for sockets — connection closed)</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">13</div><div class="code-styler-line-text">        <span class="token keyword">return</span> <span class="token boolean">False</span>  <span class="token comment"># Return True if we have already closed the transport</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">14</div><div class="code-styler-line-text"><br></div></div><div class="code-styler-line"><div class="code-styler-line-number">15</div><div class="code-styler-line-text">    <span class="token keyword">def</span> <span class="token function">connection_lost</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> exc<span class="token punctuation">:</span> tp<span class="token punctuation">.</span>Optional<span class="token punctuation">[</span>Exception<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">16</div><div class="code-styler-line-text">        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  <span class="token comment"># Transport calls this when the connection is lost or closed (with an exception in the first case)</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Event loop method to manually create a future object. Apparently, it is immediately "registered" in this event loop, unlike manual creation of <code class="code-styler-inline">Future()</code>:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">event_loop<span class="token punctuation">.</span>create_future<span class="token punctuation">(</span><span class="token punctuation">)</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Event loop method that takes a protocol factory to asynchronously launch a TCP echo client:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">transport<span class="token punctuation">,</span> protocol <span class="token operator">=</span> <span class="token keyword">await</span> event_loop<span class="token punctuation">.</span>create_connection<span class="token punctuation">(</span>protocol_factory<span class="token punctuation">,</span> host<span class="token punctuation">,</span> port<span class="token punctuation">)</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-ul"><ul class="has-list-bullet">
<li data-line="0" dir="auto"><span class="list-bullet"></span>Returns the created transport (which is usually ignored) and our protocol class object, for which one usually awaits <code class="code-styler-inline">protocol.get_response()</code>.</li>
</ul></div><div class="el-p"><p dir="auto">Data streams — the next level of abstraction, built on top of transports and protocols!<br>
Data streams are the recommended way to build network applications in <code class="code-styler-inline">asyncio</code>.</p></div><div class="el-p"><p dir="auto">The <code class="code-styler-inline">asyncio</code> method for creating a connection and obtaining a <code class="code-styler-inline">StreamReader</code> and <code class="code-styler-inline">StreamWriter</code>:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">stream_reader<span class="token punctuation">,</span> stream_writer <span class="token operator">=</span> <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>open_connection<span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto"><code class="code-styler-inline">StreamReader</code> methods:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text"><span class="token keyword">await</span> stream_reader<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token builtin">bytes</span><span class="token punctuation">)</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text"><span class="token keyword">await</span> stream_reader<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto"><code class="code-styler-inline">StreamWriter</code> methods:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">stream_writer<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token builtin">bytes</span><span class="token punctuation">)</span>  <span class="token comment"># non-blocking, writes to buffer</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text"><span class="token keyword">await</span> stream_writer<span class="token punctuation">.</span>drain<span class="token punctuation">(</span><span class="token punctuation">)</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">3</div><div class="code-styler-line-text">stream_writer<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># non-blocking</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">4</div><div class="code-styler-line-text"><span class="token keyword">await</span> stream_writer<span class="token punctuation">.</span>wait_closed<span class="token punctuation">(</span><span class="token punctuation">)</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">The basic Python function for user input is blocking!</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text"><span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">'Input your data: '</span><span class="token punctuation">)</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">By the way, there is no non-blocking version of this function))<br>
The trick <code class="code-styler-inline">await asyncio.sleep(0)</code> — "yielding control back to the event loop."</p></div><div class="el-p"><p dir="auto">A <code class="code-styler-inline">StreamReader</code> object can be created manually:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">stream_reader <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>StreamReader<span class="token punctuation">(</span><span class="token punctuation">)</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">You can get a protocol object that delegates work to a passed stream reader:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">protocol <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>StreamReaderProtocol<span class="token punctuation">(</span>stream_reader<span class="token punctuation">)</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-ul"><ul class="has-list-bullet">
<li data-line="0" dir="auto"><span class="list-bullet"></span>Such a class acting as a callable is a factory!<br>
Event loop method for connecting a <code class="code-styler-inline">StreamReader</code> object to a file-like object:</li>
</ul></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text"><span class="token keyword">await</span> event_loop<span class="token punctuation">.</span>connect_read_pipe<span class="token punctuation">(</span>protocol_factory<span class="token punctuation">,</span> pipe<span class="token punctuation">)</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text"><span class="token comment"># usage example:</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">3</div><div class="code-styler-line-text">_transport<span class="token punctuation">,</span> _protocol <span class="token operator">=</span> <span class="token keyword">await</span> event_loop<span class="token punctuation">.</span>connect_read_pipe<span class="token punctuation">(</span><span class="token keyword">lambda</span><span class="token punctuation">:</span> protocol<span class="token punctuation">,</span> sys<span class="token punctuation">.</span>stdin<span class="token punctuation">)</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-ul"><ul class="has-list-bullet">
<li data-line="0" dir="auto"><span class="list-bullet"></span>In this case, the factory always returns the same object.</li>
<li data-line="1" dir="auto"><span class="list-bullet"></span>The returned transport and protocol are usually ignored (?).</li>
</ul></div><div class="el-p"><p dir="auto">A terminal can be used in different modes:</p></div><div class="el-ul"><ul class="has-list-bullet">
<li data-line="0" dir="auto"><span class="list-bullet"></span>cooked mode — mode with processing. This is the default!</li>
<li data-line="1" dir="auto"><span class="list-bullet"></span>raw mode — mode without any processing.</li>
<li data-line="2" dir="auto"><span class="list-bullet"></span>cbreak (rare mode) — mode with processing only for control sequences.<br>
Module that allows changing the mode:</li>
</ul></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text"><span class="token keyword">import</span> tty</div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text">tty<span class="token punctuation">.</span>setraw<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdin<span class="token punctuation">)</span> — switch to raw mode</div></div><div class="code-styler-line"><div class="code-styler-line-number">3</div><div class="code-styler-line-text">tty<span class="token punctuation">.</span>setcbreak<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdin<span class="token punctuation">)</span> — switch to cbreak mode</div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Way to find the terminal size:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text"><span class="token keyword">import</span> shutil</div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text">columns<span class="token punctuation">,</span> rows <span class="token operator">=</span> shutil<span class="token punctuation">.</span>get_terminal_size<span class="token punctuation">(</span><span class="token punctuation">)</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Clear the terminal screen:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">os<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string">'clear'</span><span class="token punctuation">)</span>  <span class="token comment"># possibly for Windows: os.system('cls')</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Creating a <strong>server</strong> using data streams:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">server <span class="token operator">=</span> <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>start_server<span class="token punctuation">(</span>callback<span class="token punctuation">,</span> host<span class="token punctuation">,</span> port<span class="token punctuation">)</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text">    <span class="token keyword">async</span> <span class="token keyword">with</span> server<span class="token punctuation">:</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">3</div><div class="code-styler-line-text">        <span class="token keyword">await</span> server<span class="token punctuation">.</span>serve_forever<span class="token punctuation">(</span><span class="token punctuation">)</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-ul"><ul class="has-list-bullet">
<li data-line="0" dir="auto"><span class="list-bullet"></span><code class="code-styler-inline">server</code> is of type <code class="code-styler-inline">AbstractServer</code>.</li>
<li data-line="1" dir="auto"><span class="list-bullet"></span><code class="code-styler-inline">callback</code> — a function or coroutine. Accepts <code class="code-styler-inline">StreamReader</code> and <code class="code-styler-inline">StreamWriter</code>.</li>
</ul></div><div class="el-h1"><h1 data-heading="Chapter IX: Web Applications" dir="auto" class="heading" id="Chapter_IX_Web_Applications_0"><span class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></span>Chapter IX: Web Applications</h1></div><div class="el-p"><p dir="auto"><strong>REST</strong> (REpresentational State Transfer) — an architectural style for component interaction in a distributed network application.<br>
The main concept is a resource or endpoint (route). Examples:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">customers</div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text"><br></div></div><div class="code-styler-line"><div class="code-styler-line-number">3</div><div class="code-styler-line-text">customers<span class="token operator">/</span><span class="token number">74</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">4</div><div class="code-styler-line-text"><br></div></div><div class="code-styler-line"><div class="code-styler-line-number">5</div><div class="code-styler-line-text">customers<span class="token operator">/</span><span class="token number">74</span><span class="token operator">/</span>favorites</div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Creating a simple server based on <code class="code-styler-inline">aiohttp</code>:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text"><span class="token keyword">import</span> aiohttp</div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text"><span class="token keyword">from</span> aiohttp <span class="token keyword">import</span> web</div></div><div class="code-styler-line"><div class="code-styler-line-number">3</div><div class="code-styler-line-text"><br></div></div><div class="code-styler-line"><div class="code-styler-line-number">4</div><div class="code-styler-line-text">routes <span class="token operator">=</span> web<span class="token punctuation">.</span>RouteTableDef<span class="token punctuation">(</span><span class="token punctuation">)</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">5</div><div class="code-styler-line-text"><br></div></div><div class="code-styler-line"><div class="code-styler-line-number">6</div><div class="code-styler-line-text"><span class="token decorator annotation punctuation">@routes<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">'/time'</span><span class="token punctuation">)</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">7</div><div class="code-styler-line-text"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">time</span><span class="token punctuation">(</span>request<span class="token punctuation">:</span> aiohttp<span class="token punctuation">.</span>web_requests<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> aiohttp<span class="token punctuation">.</span>web_response<span class="token punctuation">.</span>Response<span class="token punctuation">:</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">8</div><div class="code-styler-line-text">    result <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>a<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> b<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> c<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">9</div><div class="code-styler-line-text">    <span class="token keyword">return</span> web<span class="token punctuation">.</span>json_response<span class="token punctuation">(</span>result<span class="token punctuation">)</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">10</div><div class="code-styler-line-text"><br></div></div><div class="code-styler-line"><div class="code-styler-line-number">11</div><div class="code-styler-line-text">app <span class="token operator">=</span> web<span class="token punctuation">.</span>Application<span class="token punctuation">(</span><span class="token punctuation">)</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">12</div><div class="code-styler-line-text">app<span class="token punctuation">.</span>add_routes<span class="token punctuation">(</span>routes<span class="token punctuation">)</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">13</div><div class="code-styler-line-text">web<span class="token punctuation">.</span>run_app<span class="token punctuation">(</span>app<span class="token punctuation">)</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Command-line utility for web requests:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">curl <span class="token punctuation">(</span>cURL<span class="token punctuation">)</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Adding coroutines to run at the start and end of an <code class="code-styler-inline">aiohttp</code> web application:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text"><span class="token comment"># 1</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text">app<span class="token punctuation">.</span>on_startup<span class="token punctuation">.</span>append<span class="token punctuation">(</span>coroutine<span class="token punctuation">)</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">3</div><div class="code-styler-line-text"><span class="token comment"># 2</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">4</div><div class="code-styler-line-text">app<span class="token punctuation">.</span>on_cleanup<span class="token punctuation">.</span>append<span class="token punctuation">(</span>coroutine<span class="token punctuation">)</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-ul"><ul class="has-list-bullet">
<li data-line="0" dir="auto"><span class="list-bullet"></span>Such coroutines receive the application object <code class="code-styler-inline">app</code>: <code class="code-styler-inline">aiohttp.web_app.Application</code>.</li>
</ul></div><div class="el-p"><p dir="auto">Shared resources can be stored in the application object like a dictionary via indexing:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">app<span class="token punctuation">[</span><span class="token string">'connection_pool'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token operator">&lt;</span>create connection pool<span class="token operator">&gt;</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">The <code class="code-styler-inline">request</code> object: <code class="code-styler-inline">aiohttp.web_request.Request</code>, passed to the <code class="code-styler-inline">@route</code> coroutines, contains the application:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">request<span class="token punctuation">.</span>app<span class="token punctuation">[</span><span class="token string">'connection_pool'</span><span class="token punctuation">]</span>  <span class="token comment"># Example: how to get a connection pool (e.g., to a DB)</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Creating masks and extracting passed values:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text"><span class="token decorator annotation punctuation">@routes<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">'/products/{id}'</span><span class="token punctuation">)</span>  — this decorator defines an endpoint <span class="token keyword">with</span> a mask</div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_product</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">3</div><div class="code-styler-line-text">    <span class="token builtin">id</span> <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>match_info<span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  — how to extract the passed value</div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Creating a handler for POST requests:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text"><span class="token decorator annotation punctuation">@routes<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">'/product'</span><span class="token punctuation">)</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">create_product</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">3</div><div class="code-styler-line-text">    <span class="token keyword">if</span> request<span class="token punctuation">.</span>can_read_body<span class="token punctuation">:</span>  <span class="token comment"># property!!!</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">4</div><div class="code-styler-line-text">        body <span class="token operator">=</span> <span class="token keyword">await</span> request<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">You can also return a non-JSON response from a web application:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">    <span class="token keyword">return</span> web<span class="token punctuation">.</span>Response<span class="token punctuation">(</span>status<span class="token operator">=</span><span class="token number">201</span><span class="token punctuation">)</span>  <span class="token comment"># 201: Created</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">There are special exceptions which, if raised from a request-handling coroutine, will return the corresponding error code to the user:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text"><span class="token keyword">raise</span> web<span class="token punctuation">.</span>HTTPNotFound<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 404: not found</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text"><span class="token keyword">raise</span> web<span class="token punctuation">.</span>HTTPBadRequest<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 400: bad request</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto"><strong>WSGI</strong> (Web Server Gateway Interface) — a standard for interaction between a Python program running on the server side and the web server itself (e.g., Apache).</p></div><div class="el-blockquote"><blockquote dir="auto">
<p>As I understand it, there are several levels through which a signal from a user reaches the business logic point. In order:</p>
<ol>
<li data-line="1" dir="auto">Client sends an HTTP request.</li>
<li data-line="2" dir="auto">It is received and balanced by a web server.</li>
<li data-line="3" dir="auto">The request is then translated into CGI or WSGI form, and a handler is called.</li>
<li data-line="4" dir="auto">The handler can be our code directly or a framework (like Django).</li>
<li data-line="5" dir="auto">Finally, our business logic executes. The response travels back the same way.</li>
</ol>
</blockquote></div><div class="el-p"><p dir="auto"><strong>ASGI</strong> (Asynchronous Server Gateway Interface) — a client-server protocol for interaction between a web server and an application, a further evolution of WSGI technology.</p></div><div class="el-p"><p dir="auto">Simple low-level example of an ASGI application:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">application</span><span class="token punctuation">(</span>scope<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">,</span> receive<span class="token punctuation">:</span> coroutine<span class="token punctuation">,</span> send<span class="token punctuation">:</span> coroutine<span class="token punctuation">)</span><span class="token punctuation">:</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text">    <span class="token keyword">await</span> send<span class="token punctuation">(</span><span class="token punctuation">{</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">3</div><div class="code-styler-line-text">        <span class="token string">'type'</span><span class="token punctuation">:</span> <span class="token string">'http.response.start'</span><span class="token punctuation">,</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">4</div><div class="code-styler-line-text">        <span class="token string">'status'</span><span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">5</div><div class="code-styler-line-text">        <span class="token string">'headers'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">b'content-type'</span><span class="token punctuation">,</span> <span class="token string">b'text/html'</span><span class="token punctuation">]</span><span class="token punctuation">]</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">6</div><div class="code-styler-line-text">    <span class="token punctuation">}</span><span class="token punctuation">)</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">7</div><div class="code-styler-line-text">    <span class="token keyword">await</span> send<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'type'</span><span class="token punctuation">:</span> <span class="token string">'http.response.body'</span><span class="token punctuation">,</span> <span class="token string">'body'</span><span class="token punctuation">:</span> <span class="token string">b'ASGI hello!'</span><span class="token punctuation">}</span><span class="token punctuation">)</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">And an example of launching it with the Uvicorn ASGI server:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">uvicorn chapter_09<span class="token punctuation">.</span>listing_9_7<span class="token punctuation">:</span>application</div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-ul"><ul class="has-list-bullet">
<li data-line="0" dir="auto"><span class="list-bullet"></span>Usually, it is recommended to run Uvicorn using Gunicorn.</li>
</ul></div><div class="el-p"><p dir="auto">Example of the Starlette ASGI-compatible framework:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">pip install starlette</div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-blockquote"><blockquote dir="auto">
<p>The framework was created by Encode, whose achievements include:</p>
<ul class="has-list-bullet">
<li data-line="1" dir="auto"><span class="list-bullet"></span>Development of Uvicorn.</li>
<li data-line="2" dir="auto"><span class="list-bullet"></span>REST implementation for Django.<br>
Framework pros:</li>
<li data-line="4" dir="auto"><span class="list-bullet"></span>Impressive performance.</li>
<li data-line="5" dir="auto"><span class="list-bullet"></span>WebSocket support.<br>
Documentation: <a data-tooltip-position="top" aria-label="https://www.starlette.io/" rel="noopener nofollow" class="external-link is-unresolved" href="https://www.starlette.io/" target="_self">here</a></li>
</ul>
</blockquote></div><div class="el-p"><p dir="auto">Using this framework is incredibly pleasant!</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text"><span class="token keyword">import</span> asyncpg</div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text"><span class="token keyword">from</span> starlette<span class="token punctuation">.</span>applications <span class="token keyword">import</span> Starlette</div></div><div class="code-styler-line"><div class="code-styler-line-number">3</div><div class="code-styler-line-text"><span class="token keyword">from</span> starlette<span class="token punctuation">.</span>requests <span class="token keyword">import</span> Request</div></div><div class="code-styler-line"><div class="code-styler-line-number">4</div><div class="code-styler-line-text"><span class="token keyword">from</span> starlette<span class="token punctuation">.</span>responses <span class="token keyword">import</span> JSONResponse<span class="token punctuation">,</span> Response</div></div><div class="code-styler-line"><div class="code-styler-line-number">5</div><div class="code-styler-line-text"><span class="token keyword">from</span> starlette<span class="token punctuation">.</span>routing <span class="token keyword">import</span> Route</div></div><div class="code-styler-line"><div class="code-styler-line-number">6</div><div class="code-styler-line-text"><br></div></div><div class="code-styler-line"><div class="code-styler-line-number">7</div><div class="code-styler-line-text"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">some_startup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">8</div><div class="code-styler-line-text">    app<span class="token punctuation">.</span>state<span class="token punctuation">.</span>DB <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">9</div><div class="code-styler-line-text"><br></div></div><div class="code-styler-line"><div class="code-styler-line-number">10</div><div class="code-styler-line-text"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">some_destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">11</div><div class="code-styler-line-text">    <span class="token keyword">await</span> app<span class="token punctuation">.</span>state<span class="token punctuation">.</span>DB<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">12</div><div class="code-styler-line-text"><br></div></div><div class="code-styler-line"><div class="code-styler-line-number">13</div><div class="code-styler-line-text"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">brands</span><span class="token punctuation">(</span>request<span class="token punctuation">:</span> Request<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Response<span class="token punctuation">:</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">14</div><div class="code-styler-line-text">    connection <span class="token operator">=</span> request<span class="token punctuation">.</span>app<span class="token punctuation">.</span>state<span class="token punctuation">.</span>DB</div></div><div class="code-styler-line"><div class="code-styler-line-number">15</div><div class="code-styler-line-text">    results <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">16</div><div class="code-styler-line-text">    <span class="token keyword">return</span> JSONResponse<span class="token punctuation">(</span><span class="token builtin">dict</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">)</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">17</div><div class="code-styler-line-text"><br></div></div><div class="code-styler-line"><div class="code-styler-line-number">18</div><div class="code-styler-line-text">app <span class="token operator">=</span> Starlette<span class="token punctuation">(</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">19</div><div class="code-styler-line-text">    routes<span class="token operator">=</span><span class="token punctuation">[</span>Route<span class="token punctuation">(</span><span class="token string">'/brands'</span><span class="token punctuation">,</span> brands<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">]</span><span class="token punctuation">,</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">20</div><div class="code-styler-line-text">    on_startup<span class="token operator">=</span><span class="token punctuation">[</span>some_startup<span class="token punctuation">,</span> <span class="token punctuation">]</span><span class="token punctuation">,</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">21</div><div class="code-styler-line-text">    on_shutdown<span class="token operator">=</span><span class="token punctuation">[</span>some_destroy<span class="token punctuation">,</span> <span class="token punctuation">]</span><span class="token punctuation">,</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">22</div><div class="code-styler-line-text"><span class="token punctuation">)</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Such a program is launched by specifying the name of the <code class="code-styler-inline">Starlette()</code> instance through an ASGI server. Example for Uvicorn:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">uvicorn <span class="token operator">-</span><span class="token operator">-</span>workers <span class="token number">8</span> <span class="token operator">-</span><span class="token operator">-</span>log<span class="token operator">-</span>level error mine<span class="token punctuation">.</span>_09<span class="token punctuation">.</span>first_starlette<span class="token punctuation">:</span>app</div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">When testing, this framework+server combination shows processing of around 20k requests per second! Test with the <code class="code-styler-inline">wrk</code> utility:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">wrk <span class="token operator">-</span>t1 <span class="token operator">-</span>c200 <span class="token operator">-</span>d30s http<span class="token punctuation">:</span><span class="token operator">//</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">8000</span><span class="token operator">/</span>brands</div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-blockquote"><blockquote dir="auto">
<p>Another fast recommended option: eight <code class="code-styler-inline">aiohttp</code> threads running behind NGINX.</p>
</blockquote></div><div class="el-p"><p dir="auto">How to make a long-term connection between a client and a web application?</p></div><div class="el-ul"><ul class="has-list-bullet">
<li data-line="0" dir="auto"><span class="list-bullet"></span>You could use a JavaScript script that polls an endpoint in a loop, but this has drawbacks.</li>
<li data-line="1" dir="auto"><span class="list-bullet"></span>WebSockets.</li>
</ul></div><div class="el-p"><p dir="auto">Generally, Sockets and WebSockets are different concepts and should not be confused.</p></div><div class="el-p"><p dir="auto">Starlette supports WebSockets, but they must be installed separately:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">pip install websockets</div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Using WebSockets in Starlette:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text"><span class="token keyword">import</span> asyncio</div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text"><span class="token keyword">from</span> starlette<span class="token punctuation">.</span>applications <span class="token keyword">import</span> Starlette</div></div><div class="code-styler-line"><div class="code-styler-line-number">3</div><div class="code-styler-line-text"><span class="token keyword">from</span> starlette<span class="token punctuation">.</span>endpoints <span class="token keyword">import</span> WebSocketEndpoint</div></div><div class="code-styler-line"><div class="code-styler-line-number">4</div><div class="code-styler-line-text"><span class="token keyword">from</span> starlette<span class="token punctuation">.</span>routing <span class="token keyword">import</span> WebSocketRoute</div></div><div class="code-styler-line"><div class="code-styler-line-number">5</div><div class="code-styler-line-text"><br></div></div><div class="code-styler-line"><div class="code-styler-line-number">6</div><div class="code-styler-line-text"><span class="token keyword">class</span> <span class="token class-name">WSEndpoint</span><span class="token punctuation">(</span>WebSocketEndpoint<span class="token punctuation">)</span><span class="token punctuation">:</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">7</div><div class="code-styler-line-text">    encoding <span class="token operator">=</span> <span class="token string">'text'</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">8</div><div class="code-styler-line-text">    shared_data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># example</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">9</div><div class="code-styler-line-text"><br></div></div><div class="code-styler-line"><div class="code-styler-line-number">10</div><div class="code-styler-line-text">    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">on_connect</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> websocket<span class="token punctuation">)</span><span class="token punctuation">:</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">11</div><div class="code-styler-line-text">        <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># must accept!</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">12</div><div class="code-styler-line-text">        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">13</div><div class="code-styler-line-text"><br></div></div><div class="code-styler-line"><div class="code-styler-line-number">14</div><div class="code-styler-line-text">    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">on_disconnect</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> websocket<span class="token punctuation">,</span> close_code<span class="token punctuation">)</span><span class="token punctuation">:</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">15</div><div class="code-styler-line-text">        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">16</div><div class="code-styler-line-text"><br></div></div><div class="code-styler-line"><div class="code-styler-line-number">17</div><div class="code-styler-line-text">    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">on_receive</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> websocket<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">18</div><div class="code-styler-line-text">        <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>send_text<span class="token punctuation">(</span><span class="token string">'hello world!'</span><span class="token punctuation">)</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">19</div><div class="code-styler-line-text"><br></div></div><div class="code-styler-line"><div class="code-styler-line-number">20</div><div class="code-styler-line-text">app <span class="token operator">=</span> Starlette<span class="token punctuation">(</span>routes<span class="token operator">=</span><span class="token punctuation">[</span>WebSocketRoute<span class="token punctuation">(</span><span class="token string">'/ws_page'</span><span class="token punctuation">,</span> WSEndpoint<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">! When running this code on a server, if <code class="code-styler-inline">shared_data</code> is used, you must work with 1 worker! Example:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">uvicorn <span class="token operator">-</span><span class="token operator">-</span>workers <span class="token number">1</span> my_pack<span class="token punctuation">.</span>my_module<span class="token punctuation">:</span>app</div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">To work with this type of WebSocket endpoint, a special script inside the HTML is required:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text"><span class="token operator">&lt;</span>script<span class="token operator">&gt;</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text">    document<span class="token punctuation">.</span>addEventListener<span class="token punctuation">(</span><span class="token string">"DOMContentLoaded"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">3</div><div class="code-styler-line-text">        let socket <span class="token operator">=</span> new WebSocket<span class="token punctuation">(</span><span class="token string">"ws://localhost:8000/counter"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">4</div><div class="code-styler-line-text">        socket<span class="token punctuation">.</span>onmessage <span class="token operator">=</span> <span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">5</div><div class="code-styler-line-text">            const counter <span class="token operator">=</span> document<span class="token punctuation">.</span>querySelector<span class="token punctuation">(</span><span class="token string">"#counter"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">6</div><div class="code-styler-line-text">            counter<span class="token punctuation">.</span>textContent <span class="token operator">=</span> event<span class="token punctuation">.</span>data<span class="token punctuation">;</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">7</div><div class="code-styler-line-text">        <span class="token punctuation">}</span><span class="token punctuation">;</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">8</div><div class="code-styler-line-text">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">9</div><div class="code-styler-line-text"><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto"><u>Definition</u>:<br>
<em>DOM</em> (Document Object Model) — a platform- and language-neutral interface that allows programs and scripts to dynamically access and update the content, structure, and style of HTML, XHTML, and XML documents. The DOM model does not impose restrictions on the document structure.</p></div><div class="el-p"><p dir="auto"><mark><strong>Django</strong></mark><br>
The "Royal" framework for creating web applications, including many features from ORM to an admin panel. It operates with concepts like <em>views</em>, HTML <em>templates</em>, and others.</p></div><div class="el-blockquote"><blockquote dir="auto">
<p>WARNING Not Found: /favicon.ico in Django occurs because browsers by default try to request this page to get a site icon for bookmarks and other places.</p>
</blockquote></div><div class="el-p"><p dir="auto">Creating a project in Django:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">django<span class="token operator">-</span>admin startproject async_views</div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Running it on the Uvicorn ASGI server:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">gunicorn async_views<span class="token punctuation">.</span>asgi<span class="token punctuation">:</span>application <span class="token operator">-</span>k uvicorn<span class="token punctuation">.</span>workers<span class="token punctuation">.</span>UvicornWorker</div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Creating a Django app:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">python3 manage<span class="token punctuation">.</span>py startapp async_api</div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Where views are defined:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">my_project<span class="token operator">/</span>my_app<span class="token operator">/</span>views<span class="token punctuation">.</span>py</div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">A view is written as a function or coroutine (for an asynchronous view):</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text"><span class="token keyword">from</span> django<span class="token punctuation">.</span>shortcuts <span class="token keyword">import</span> render</div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text"><br></div></div><div class="code-styler-line"><div class="code-styler-line-number">3</div><div class="code-styler-line-text"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">requests_view</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># request — the incoming web request passed to this code</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">4</div><div class="code-styler-line-text">    param_value <span class="token operator">=</span> request<span class="token punctuation">.</span>GET<span class="token punctuation">[</span><span class="token string">'param_name'</span><span class="token punctuation">]</span>  <span class="token comment"># way to extract something from the request</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">5</div><div class="code-styler-line-text">    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">6</div><div class="code-styler-line-text">    <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> template_name<span class="token punctuation">,</span> context<span class="token operator">=</span>result<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">7</div><div class="code-styler-line-text">    <span class="token comment"># templates — HTML templates</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">The request itself looks something like this, for example:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">http<span class="token punctuation">:</span><span class="token operator">//</span>localhost<span class="token punctuation">:</span><span class="token number">8000</span><span class="token operator">/</span>requests<span class="token operator">/</span>?param_name<span class="token operator">=</span>http<span class="token punctuation">:</span><span class="token operator">//</span>example<span class="token punctuation">.</span>com<span class="token operator">&amp;</span>other_param<span class="token operator">=</span><span class="token number">10</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Where templates are defined:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">my_project<span class="token operator">/</span>my_app<span class="token operator">/</span>templates<span class="token operator">/</span>my_app<span class="token operator">/</span>template_name<span class="token punctuation">.</span>extension</div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Where templates are linked to views:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">my_project<span class="token operator">/</span>my_app<span class="token operator">/</span>urls<span class="token punctuation">.</span>py</div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text">urlpatterns <span class="token builtin">list</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Where the web application URL is linked to the Django project:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">my_project<span class="token operator">/</span>my_project<span class="token operator">/</span>urls<span class="token punctuation">.</span>py</div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text">urlpatterns <span class="token builtin">list</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">And finally, where applications are added to the installed list for the entire project:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">my_project<span class="token operator">/</span>my_project<span class="token operator">/</span>settings<span class="token punctuation">.</span>py</div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text">INSTALLED_APPS <span class="token builtin">list</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">IMPORTANT note:<br>
Even when running through a synchronous WSGI server, we can leverage the advantages of asynchronous code. However, a NEW event loop is created for each request, which is why things requiring the same event loop will still only work in an ASGI application.</p></div><div class="el-p"><p dir="auto">The ASGI specification provides functions in the <code class="code-styler-inline">asgiref.sync</code> package:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">sync_to_async<span class="token punctuation">(</span>func<span class="token punctuation">,</span> thread_sensitive<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Used for executing blocking work within an async view (similar to using a thread pool for synchronous APIs). But there is a nuance:</p></div><div class="el-blockquote"><blockquote dir="auto">
<p>By default, it is thread-sensitive. This means the work will run in Django's main thread, thereby blocking the WSGI/ASGI worker process. You can change this to <code class="code-styler-inline">thread_sensitive=False</code>, but then race conditions in synchronous APIs are possible—be careful!</p>
</blockquote></div><div class="el-p"><p dir="auto">Also in this package:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">async_to_sync<span class="token punctuation">(</span>func<span class="token punctuation">)</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">For converting a coroutine into a function executed in the current ASGI event loop (or a new loop for each WSGI request). Such a function will return results synchronously.</p></div><div class="el-h1"><h1 data-heading="Chapter X: Microservices" dir="auto" class="heading" id="Chapter_X_Microservices_0"><span class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></span>Chapter X: Microservices</h1></div><div class="el-p"><p dir="auto">What is a microservice? Key characteristics:</p></div><div class="el-ol"><ol>
<li data-line="0" dir="auto">Loosely coupled and independently deployed.</li>
<li data-line="1" dir="auto">Each microservice has its own technology stack and data model.</li>
<li data-line="2" dir="auto">They communicate with each other via a protocol, such as REST or gRPC.</li>
<li data-line="3" dir="auto">Follow the Single Responsibility Principle: each service does one thing and does it well!</li>
</ol></div><div class="el-p"><p dir="auto">For comparison, pros of monoliths:</p></div><div class="el-ul"><ul class="has-list-bullet">
<li data-line="0" dir="auto"><span class="list-bullet"></span>Simple testing and deployment after changes.</li>
<li data-line="1" dir="auto"><span class="list-bullet"></span>Scaling (vertical/horizontal) is straightforward—just deploy additional instances or upgrade hardware.<br>
But there are disadvantages:</li>
<li data-line="3" dir="auto"><span class="list-bullet"></span>Complex code: modules and dependencies grow, increasing technical debt. Everything becomes slow and tangled.</li>
<li data-line="4" dir="auto"><span class="list-bullet"></span>Scaling difficulties: you have to duplicate all parts, even those with low load, leading to inefficient costs.</li>
<li data-line="5" dir="auto"><span class="list-bullet"></span>Team and stack dependency: many teams committing different changes lead to merge conflicts and coordination overhead.<br>
These downsides are mitigated in a microservice architecture!</li>
</ul></div><div class="el-p"><p dir="auto">[Image of Monolithic vs Microservices architecture]</p></div><div class="el-blockquote"><blockquote dir="auto">
<p>Since you can communicate with multiple microservices simultaneously, we gain the ability for concurrency and efficiency impossible in a synchronous application!</p>
</blockquote></div><div class="el-p"><p dir="auto">Good pattern: <strong>Backend-for-Frontend (BFF)</strong>. The essence is that the frontend doesn't talk to microservices directly. Instead, it hits a single specialized "BFF" service that sends multiple requests to various microservices and returns an aggregated result to the frontend. This is beneficial because our service isn't limited by frontend constraints (slow internet, weak hardware, different devices).</p></div><div class="el-h1"><h1 data-heading="Chapter XI: Synchronization" dir="auto" class="heading" id="Chapter_XI_Synchronization_0"><span class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></span>Chapter XI: Synchronization</h1></div><div class="el-p"><p dir="auto">Asyncio locks:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text"><span class="token keyword">from</span> asyncio <span class="token keyword">import</span> Lock</div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text"><br></div></div><div class="code-styler-line"><div class="code-styler-line-number">3</div><div class="code-styler-line-text"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span>lock<span class="token punctuation">:</span> Lock<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># f(Lock())</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">4</div><div class="code-styler-line-text">    <span class="token keyword">async</span> <span class="token keyword">with</span> lock<span class="token punctuation">:</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">5</div><div class="code-styler-line-text">        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">6</div><div class="code-styler-line-text"><br></div></div><div class="code-styler-line"><div class="code-styler-line-number">7</div><div class="code-styler-line-text"><span class="token comment"># OR:</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">8</div><div class="code-styler-line-text"><br></div></div><div class="code-styler-line"><div class="code-styler-line-number">9</div><div class="code-styler-line-text"><span class="token keyword">await</span> lock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">await</span> lock<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Be careful calling <code class="code-styler-inline">Lock()</code> before starting the main event loop, because asyncio will create a new loop for the optional <em>loop</em> parameter of this call! (This applies to other asyncio objects as well).</p></div><div class="el-p"><p dir="auto">Pattern for limiting request bursts per second:</p></div><div class="el-blockquote"><blockquote dir="auto">
<p>"Leaky Bucket"</p>
</blockquote></div><div class="el-p"><p dir="auto">A semaphore that raises an error if you try to release it more times than it was acquired:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">asyncio<span class="token punctuation">.</span>BoundedSemaphore</div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Another synchronization primitive (Event):</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">event <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>Event<span class="token punctuation">(</span><span class="token punctuation">)</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text"><span class="token keyword">await</span> event<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># unblocks when someone calls event.set()</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">3</div><div class="code-styler-line-text">event<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># resets the event</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">And another primitive (Condition):</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">cnd <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>Condition<span class="token punctuation">(</span><span class="token punctuation">)</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text"><span class="token keyword">async</span> <span class="token keyword">with</span> cnd<span class="token punctuation">:</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">3</div><div class="code-styler-line-text">    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">4</div><div class="code-styler-line-text">    cnd<span class="token punctuation">.</span>notify_all<span class="token punctuation">(</span><span class="token punctuation">)</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">5</div><div class="code-styler-line-text"><span class="token keyword">async</span> <span class="token keyword">with</span> cnd<span class="token punctuation">:</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">6</div><div class="code-styler-line-text">    <span class="token keyword">await</span> cnd<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># OR await cnd.wait_for(predicate)</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Conditions are useful when access to a shared resource is needed, but you must wait for a specific state before starting work.</p></div><div class="el-h1"><h1 data-heading="Chapter XII: Asynchronous Queues" dir="auto" class="heading" id="Chapter_XII_Asynchronous_Queues_0"><span class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></span>Chapter XII: Asynchronous Queues</h1></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">asyncio<span class="token punctuation">.</span>Queue<span class="token punctuation">(</span>maxsize<span class="token operator">=</span><span class="token operator">&lt;</span>default<span class="token operator">&gt;</span><span class="token punctuation">)</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text"><span class="token keyword">await</span> queue<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token punctuation">)</span> OR queue<span class="token punctuation">.</span>put_nowait<span class="token punctuation">(</span><span class="token punctuation">)</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">3</div><div class="code-styler-line-text"><span class="token keyword">await</span> queue<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span> OR queue<span class="token punctuation">.</span>get_nowait<span class="token punctuation">(</span><span class="token punctuation">)</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">4</div><div class="code-styler-line-text">queue<span class="token punctuation">.</span>task_done<span class="token punctuation">(</span><span class="token punctuation">)</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">5</div><div class="code-styler-line-text"><span class="token keyword">await</span> queue<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># wait until the queue is empty</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Examples of queues with disk storage: Celery, RabbitMQ.</p></div><div class="el-p"><p dir="auto">Popular HTML parsing library:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">BeautifulSoup</div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Priority queue based on Python's binary heap <code class="code-styler-inline">heapq</code>:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">asyncio<span class="token punctuation">.</span>PriorityQueue</div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-ul"><ul class="has-list-bullet">
<li data-line="0" dir="auto"><span class="list-bullet"></span>Uses a min-heap by default, meaning tasks with lower numbers are considered higher priority.</li>
</ul></div><div class="el-blockquote"><blockquote dir="auto">
<p>Magic methods are also called "dunder" methods (from "double underscore").</p>
</blockquote></div><div class="el-p"><p dir="auto">The processing order for elements in a priority queue with <strong>equal</strong> priority is undefined! If necessary, you can add a sequence number manually.</p></div><div class="el-p"><p dir="auto">Another type of queue, the stack:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">asyncio<span class="token punctuation">.</span>LifoQueue</div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h1"><h1 data-heading="Chapter XIII: Subprocess Management" dir="auto" class="heading" id="Chapter_XIII_Subprocess_Management_0"><span class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></span>Chapter XIII: Subprocess Management</h1></div><div class="el-p"><p dir="auto">Subprocesses can be run in blocking mode using <code class="code-styler-inline">subprocess</code>, but asyncio offers a non-blocking API for creating and managing subprocesses as coroutines:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">asyncio<span class="token punctuation">.</span>subprocess</div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Basics:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">asyncio<span class="token punctuation">.</span>create_subprocess_exec  <span class="token comment"># without an OS shell, preferred</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text">asyncio<span class="token punctuation">.</span>create_subprocess_shell</div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Arguments:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text"><span class="token punctuation">(</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text">    <span class="token operator">*</span>args<span class="token punctuation">,</span>  <span class="token comment"># command and arguments to run</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">3</div><div class="code-styler-line-text">    stdin<span class="token operator">=</span><span class="token punctuation">,</span>  <span class="token comment"># where to get input from; asyncio.subprocess.PIPE creates a StreamWriter</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">4</div><div class="code-styler-line-text">    stdout<span class="token operator">=</span><span class="token punctuation">,</span> <span class="token comment"># where to direct output; asyncio.subprocess.PIPE creates a StreamReader</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">5</div><div class="code-styler-line-text">    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">6</div><div class="code-styler-line-text"><span class="token punctuation">)</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Returns a <code class="code-styler-inline">Process</code> object. Key methods and fields:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text"><span class="token keyword">await</span> prc<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># coroutine returning the exit code</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text"><br></div></div><div class="code-styler-line"><div class="code-styler-line-number">3</div><div class="code-styler-line-text">prc<span class="token punctuation">.</span>terminate<span class="token punctuation">(</span><span class="token punctuation">)</span> OR prc<span class="token punctuation">.</span>kill<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># sends SIGTERM or SIGKILL respectively</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">4</div><div class="code-styler-line-text"><br></div></div><div class="code-styler-line"><div class="code-styler-line-number">5</div><div class="code-styler-line-text">prc<span class="token punctuation">.</span>stdout  <span class="token comment"># field containing the StreamReader created via asyncio.subprocess.PIPE</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">6</div><div class="code-styler-line-text"><br></div></div><div class="code-styler-line"><div class="code-styler-line-number">7</div><div class="code-styler-line-text"><span class="token keyword">await</span> prc<span class="token punctuation">.</span>communicate<span class="token punctuation">(</span><span class="token punctuation">[</span>text<span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># returns (stdout, stderr). Interactively reads into an internal buffer concurrently. 'text' is sent to stdin.</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Problem: A subprocess outputs a lot of data to <code class="code-styler-inline">asyncio.subprocess.PIPE</code>, but our main process doesn't read them and waits. The subprocess blocks waiting for the buffer to clear. This can be solved by avoiding <code class="code-styler-inline">await prc.wait()</code> or using <code class="code-styler-inline">prc.communicate()</code>, but the latter might cause high memory usage.</p></div><div class="el-p"><p dir="auto">Overfill and system overload problems can be solved using semaphores!</p></div><div class="el-p"><p dir="auto">If a subprocess non-deterministically requests input between several outputs, it’s best to use separate coroutines for reading <code class="code-styler-inline">stdout</code> and writing to <code class="code-styler-inline">stdin</code> using <code class="code-styler-inline">asyncio.Event</code>.</p></div><div class="el-h1"><h1 data-heading="Chapter XIV: Advanced `asyncio` Usage" dir="auto" class="heading" id="Chapter_XIV_Advanced_`asyncio`_Usage_0"><span class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></span>Chapter XIV: Advanced <code class="code-styler-inline">asyncio</code> Usage</h1></div><div class="el-p"><p dir="auto">Checking a function for its async class and properly scheduling it in the event loop:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text"><span class="token keyword">if</span> asyncio<span class="token punctuation">.</span>iscoroutinefunction<span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token comment"># func that creates a coroutine</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text">    <span class="token operator">&lt;</span>tasks append<span class="token operator">&gt;</span> asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>func<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">3</div><div class="code-styler-line-text"><span class="token keyword">elif</span> asyncio<span class="token punctuation">.</span>iscoroutine<span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>                  <span class="token comment"># func that is already a coroutine</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">4</div><div class="code-styler-line-text">    <span class="token operator">&lt;</span>tasks append<span class="token operator">&gt;</span> asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>func<span class="token punctuation">)</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">5</div><div class="code-styler-line-text"><span class="token keyword">else</span><span class="token punctuation">:</span>                                            <span class="token comment"># regular func</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">6</div><div class="code-styler-line-text">    loop<span class="token punctuation">.</span>call_soon<span class="token punctuation">(</span>func<span class="token punctuation">)</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">7</div><div class="code-styler-line-text"><br></div></div><div class="code-styler-line"><div class="code-styler-line-number">8</div><div class="code-styler-line-text"><span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>gather<span class="token punctuation">(</span><span class="token operator">*</span>tasks<span class="token punctuation">)</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">9</div><div class="code-styler-line-text"><br></div></div><div class="code-styler-line"><div class="code-styler-line-number">10</div><div class="code-styler-line-text">loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span><span class="token operator">^</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># ^ — the code above as a function</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">For multithreaded programs, there are thread-local variables (see the <code class="code-styler-inline">threading</code> module docs).</p></div><div class="el-p"><p dir="auto">For single-threaded concurrency, the equivalent is:</p></div><div class="el-blockquote"><blockquote dir="auto">
<p>Context Variables<br>
Implemented in the <code class="code-styler-inline">contextvars</code> module:</p>
</blockquote></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">var <span class="token operator">=</span> contextvars<span class="token punctuation">.</span>ContextVar<span class="token punctuation">(</span><span class="token string">'var_name'</span><span class="token punctuation">)</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text">var<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">3</div><div class="code-styler-line-text">var<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Optimized idiom to yield to the next iteration of the event loop:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Be aware that other event loop implementations exist! For example, <code class="code-styler-inline">uvloop</code>:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text">pip install uvloop</div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Built on a C library, making it faster, especially for streaming I/O and sockets. How to switch:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text"><span class="token keyword">import</span> uvloop</div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text"><br></div></div><div class="code-styler-line"><div class="code-styler-line-number">3</div><div class="code-styler-line-text">uvloop<span class="token punctuation">.</span>install<span class="token punctuation">(</span><span class="token punctuation">)</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">4</div><div class="code-styler-line-text">asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">5</div><div class="code-styler-line-text"><br></div></div><div class="code-styler-line"><div class="code-styler-line-number">6</div><div class="code-styler-line-text"><span class="token comment"># OR</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">7</div><div class="code-styler-line-text"><br></div></div><div class="code-styler-line"><div class="code-styler-line-number">8</div><div class="code-styler-line-text">asyncio<span class="token punctuation">.</span>set_event_loop<span class="token punctuation">(</span>uvloop<span class="token punctuation">.</span>new_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">9</div><div class="code-styler-line-text">asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-blockquote"><blockquote dir="auto">
<p>IMPORTANT: The <code class="code-styler-inline">async/await</code> syntax and coroutines are conceptually separate from <code class="code-styler-inline">asyncio</code>. You can write your own event loop to manage coroutine execution!</p>
</blockquote></div><div class="el-p"><p dir="auto">To understand this, look at how coroutines were written before <code class="code-styler-inline">async/await</code>. This highlights the close link between coroutines and generators:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text"><span class="token decorator annotation punctuation">@asyncio<span class="token punctuation">.</span>coroutine</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text"><span class="token keyword">def</span> <span class="token function">coroutine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">3</div><div class="code-styler-line-text">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'do hard work asynchronously'</span><span class="token punctuation">)</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">4</div><div class="code-styler-line-text">    <span class="token keyword">yield</span> <span class="token keyword">from</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">5</div><div class="code-styler-line-text">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'work is done!'</span><span class="token punctuation">)</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">6</div><div class="code-styler-line-text"><br></div></div><div class="code-styler-line"><div class="code-styler-line-number">7</div><div class="code-styler-line-text">asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>coroutine<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto"><code class="code-styler-inline">async/await</code> is syntactic sugar wrapping this construction!</p></div><div class="el-p"><p dir="auto">Example class clarifying the <code class="code-styler-inline">__await__</code> dunder method and the concept of implementing single-threaded concurrency via iterators:</p></div><div class="el-pre code-styler-pre-parent"><pre class="language-python code-styler-pre" defaultfold="false"><div class="code-styler-header-container-hidden"></div><code data-line="0" class="language-python is-loaded"><div class="code-styler-line"><div class="code-styler-line-number">1</div><div class="code-styler-line-text"><span class="token keyword">class</span> <span class="token class-name">CustomFuture</span><span class="token punctuation">:</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">2</div><div class="code-styler-line-text"><br></div></div><div class="code-styler-line"><div class="code-styler-line-number">3</div><div class="code-styler-line-text">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">4</div><div class="code-styler-line-text">        self<span class="token punctuation">.</span>_result <span class="token operator">=</span> <span class="token boolean">None</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">5</div><div class="code-styler-line-text">        self<span class="token punctuation">.</span>_is_finished <span class="token operator">=</span> <span class="token boolean">False</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">6</div><div class="code-styler-line-text">        self<span class="token punctuation">.</span>_done_callback <span class="token operator">=</span> <span class="token boolean">None</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">7</div><div class="code-styler-line-text"><br></div></div><div class="code-styler-line"><div class="code-styler-line-number">8</div><div class="code-styler-line-text">    <span class="token keyword">def</span> <span class="token function">result</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">9</div><div class="code-styler-line-text">        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_result</div></div><div class="code-styler-line"><div class="code-styler-line-number">10</div><div class="code-styler-line-text"><br></div></div><div class="code-styler-line"><div class="code-styler-line-number">11</div><div class="code-styler-line-text">    <span class="token keyword">def</span> <span class="token function">is_finished</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">12</div><div class="code-styler-line-text">        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_is_finished</div></div><div class="code-styler-line"><div class="code-styler-line-number">13</div><div class="code-styler-line-text"><br></div></div><div class="code-styler-line"><div class="code-styler-line-number">14</div><div class="code-styler-line-text">    <span class="token keyword">def</span> <span class="token function">set_result</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">:</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">15</div><div class="code-styler-line-text">        self<span class="token punctuation">.</span>_result <span class="token operator">=</span> result</div></div><div class="code-styler-line"><div class="code-styler-line-number">16</div><div class="code-styler-line-text">        self<span class="token punctuation">.</span>_is_finished <span class="token operator">=</span> <span class="token boolean">True</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">17</div><div class="code-styler-line-text">        <span class="token keyword">if</span> self<span class="token punctuation">.</span>_done_callback<span class="token punctuation">:</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">18</div><div class="code-styler-line-text">            self<span class="token punctuation">.</span>_done_callback<span class="token punctuation">(</span>result<span class="token punctuation">)</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">19</div><div class="code-styler-line-text"><br></div></div><div class="code-styler-line"><div class="code-styler-line-number">20</div><div class="code-styler-line-text">    <span class="token keyword">def</span> <span class="token function">add_done_callback</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">:</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">21</div><div class="code-styler-line-text">        self<span class="token punctuation">.</span>_done_callback <span class="token operator">=</span> fn</div></div><div class="code-styler-line"><div class="code-styler-line-number">22</div><div class="code-styler-line-text"><br></div></div><div class="code-styler-line"><div class="code-styler-line-number">23</div><div class="code-styler-line-text">    <span class="token keyword">def</span> <span class="token function">__await__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">24</div><div class="code-styler-line-text">        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>_is_finished<span class="token punctuation">:</span></div></div><div class="code-styler-line"><div class="code-styler-line-number">25</div><div class="code-styler-line-text">            <span class="token keyword">yield</span> self</div></div><div class="code-styler-line"><div class="code-styler-line-number">26</div><div class="code-styler-line-text">        <span class="token keyword">return</span> self<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span></div></div></code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">You can create your own <code class="code-styler-inline">class CustomTask(CustomFuture)</code> and a <code class="code-styler-inline">class CustomEventLoop</code> to concurrently execute coroutines without <code class="code-styler-inline">asyncio</code> at all!!!</p></div><div class="footer"><div class="data-bar"></div></div></div></div></div><div id="right-content" class="leaf" style="--sidebar-width: var(--sidebar-width-right);"><div id="right-sidebar" class="sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"><label class="theme-toggle-container" for="theme-toggle-input" id=""><input class="theme-toggle-input" type="checkbox" id="theme-toggle-input"><div class="toggle-background"></div></label></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content-wrapper"><div id="right-sidebar-content" class="leaf-content"><div id="outline" class=" tree-container"><div class="feature-header"><div class="feature-title">Table Of Contents</div><button class="clickable-icon nav-action-button tree-collapse-all is-collapsed" aria-label="Collapse All"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></svg></button></div><div class="tree-item is-collapsed" data-depth="1"><a class="tree-item-self is-clickable" href="py-asyncio.html#Py_Asyncio_0" data-path="#Py_Asyncio_0"><div class="tree-item-inner heading-link" heading-name="Py Asyncio">Py Asyncio</div></a><div class="tree-item-children"></div></div><div class="tree-item is-collapsed" data-depth="1"><a class="tree-item-self is-clickable" href="py-asyncio.html#Chapters_I_&amp;_II_Introduction_to_`asyncio`,_The_Basics_0" data-path="#Chapters_I_&amp;_II_Introduction_to_`asyncio`,_The_Basics_0"><div class="tree-item-inner heading-link" heading-name="Chapters I &amp; II: Introduction to `asyncio`, The Basics">Chapters I &amp; II: Introduction to <code class="code-styler-inline">asyncio</code>, The Basics</div></a><div class="tree-item-children"></div></div><div class="tree-item is-collapsed" data-depth="1"><a class="tree-item-self is-clickable" href="py-asyncio.html#Chapter_III_First_`asyncio`_Application._Echo_Server_0" data-path="#Chapter_III_First_`asyncio`_Application._Echo_Server_0"><div class="tree-item-inner heading-link" heading-name="Chapter III: First `asyncio` Application. Echo Server">Chapter III: First <code class="code-styler-inline">asyncio</code> Application. Echo Server</div></a><div class="tree-item-children"></div></div><div class="tree-item is-collapsed" data-depth="1"><a class="tree-item-self is-clickable" href="py-asyncio.html#Chapter_IV_Concurrent_Web_Requests_0" data-path="#Chapter_IV_Concurrent_Web_Requests_0"><div class="tree-item-inner heading-link" heading-name="Chapter IV: Concurrent Web Requests">Chapter IV: Concurrent Web Requests</div></a><div class="tree-item-children"></div></div><div class="tree-item is-collapsed" data-depth="1"><a class="tree-item-self is-clickable" href="py-asyncio.html#Chapter_V_Non-blocking_DB_Drivers_0" data-path="#Chapter_V_Non-blocking_DB_Drivers_0"><div class="tree-item-inner heading-link" heading-name="Chapter V: Non-blocking DB Drivers">Chapter V: Non-blocking DB Drivers</div></a><div class="tree-item-children"></div></div><div class="tree-item is-collapsed" data-depth="1"><a class="tree-item-self is-clickable" href="py-asyncio.html#Chapter_VI_CPU-bound_Tasks_0" data-path="#Chapter_VI_CPU-bound_Tasks_0"><div class="tree-item-inner heading-link" heading-name="Chapter VI: CPU-bound Tasks">Chapter VI: CPU-bound Tasks</div></a><div class="tree-item-children"></div></div><div class="tree-item is-collapsed" data-depth="1"><a class="tree-item-self is-clickable" href="py-asyncio.html#Chapter_VII_Solving_Blocking_Issues_with_Threads_0" data-path="#Chapter_VII_Solving_Blocking_Issues_with_Threads_0"><div class="tree-item-inner heading-link" heading-name="Chapter VII: Solving Blocking Issues with Threads">Chapter VII: Solving Blocking Issues with Threads</div></a><div class="tree-item-children"></div></div><div class="tree-item is-collapsed" data-depth="1"><a class="tree-item-self is-clickable" href="py-asyncio.html#Chapter_VIII_Data_Streams_0" data-path="#Chapter_VIII_Data_Streams_0"><div class="tree-item-inner heading-link" heading-name="Chapter VIII: Data Streams">Chapter VIII: Data Streams</div></a><div class="tree-item-children"></div></div><div class="tree-item is-collapsed" data-depth="1"><a class="tree-item-self is-clickable" href="py-asyncio.html#Chapter_IX_Web_Applications_0" data-path="#Chapter_IX_Web_Applications_0"><div class="tree-item-inner heading-link" heading-name="Chapter IX: Web Applications">Chapter IX: Web Applications</div></a><div class="tree-item-children"></div></div><div class="tree-item is-collapsed" data-depth="1"><a class="tree-item-self is-clickable" href="py-asyncio.html#Chapter_X_Microservices_0" data-path="#Chapter_X_Microservices_0"><div class="tree-item-inner heading-link" heading-name="Chapter X: Microservices">Chapter X: Microservices</div></a><div class="tree-item-children"></div></div><div class="tree-item is-collapsed" data-depth="1"><a class="tree-item-self is-clickable" href="py-asyncio.html#Chapter_XI_Synchronization_0" data-path="#Chapter_XI_Synchronization_0"><div class="tree-item-inner heading-link" heading-name="Chapter XI: Synchronization">Chapter XI: Synchronization</div></a><div class="tree-item-children"></div></div><div class="tree-item is-collapsed" data-depth="1"><a class="tree-item-self is-clickable" href="py-asyncio.html#Chapter_XII_Asynchronous_Queues_0" data-path="#Chapter_XII_Asynchronous_Queues_0"><div class="tree-item-inner heading-link" heading-name="Chapter XII: Asynchronous Queues">Chapter XII: Asynchronous Queues</div></a><div class="tree-item-children"></div></div><div class="tree-item is-collapsed" data-depth="1"><a class="tree-item-self is-clickable" href="py-asyncio.html#Chapter_XIII_Subprocess_Management_0" data-path="#Chapter_XIII_Subprocess_Management_0"><div class="tree-item-inner heading-link" heading-name="Chapter XIII: Subprocess Management">Chapter XIII: Subprocess Management</div></a><div class="tree-item-children"></div></div><div class="tree-item is-collapsed" data-depth="1"><a class="tree-item-self is-clickable" href="py-asyncio.html#Chapter_XIV_Advanced_`asyncio`_Usage_0" data-path="#Chapter_XIV_Advanced_`asyncio`_Usage_0"><div class="tree-item-inner heading-link" heading-name="Chapter XIV: Advanced `asyncio` Usage">Chapter XIV: Advanced <code class="code-styler-inline">asyncio</code> Usage</div></a><div class="tree-item-children"></div></div></div></div></div><script defer="">let rs = document.querySelector("#right-sidebar"); rs.classList.toggle("is-collapsed", window.innerWidth < 768); rs.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-right-width"));</script></div></div></div></div></body></html>